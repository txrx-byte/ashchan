# Ashchan Moderation/Anti-Spam Service Configuration
# mTLS ServiceMesh Environment

# ─────────────────────────────────────────────────────────────
# Service Identity
# ─────────────────────────────────────────────────────────────
APP_NAME=moderation-anti-spam
APP_ENV=local
SERVICE_NAME=moderation
SERVICE_DNS_NAME=moderation.ashchan.local

# ─────────────────────────────────────────────────────────────
# Server Configuration
# ─────────────────────────────────────────────────────────────
# HTTP port (development only)
HTTP_PORT=9506

# Internal mTLS port (service-to-service)
MTLS_PORT=8448

# ─────────────────────────────────────────────────────────────
# mTLS Configuration (Service-to-Service)
# ─────────────────────────────────────────────────────────────
MTLS_ENABLED=true
MTLS_CERT_FILE=__PROJECT_ROOT__/certs/services/moderation/moderation.crt
MTLS_KEY_FILE=__PROJECT_ROOT__/certs/services/moderation/moderation.key
MTLS_CA_FILE=__PROJECT_ROOT__/certs/ca/ca.crt
MTLS_VERIFY_PEER=true
MTLS_MIN_TLS_VERSION=TLSv1.3

# Client certificates for outbound calls
MTLS_CLIENT_CERT_FILE=__PROJECT_ROOT__/certs/services/moderation/moderation.crt
MTLS_CLIENT_KEY_FILE=__PROJECT_ROOT__/certs/services/moderation/moderation.key

# ─────────────────────────────────────────────────────────────
# Database (PostgreSQL)
# ─────────────────────────────────────────────────────────────
DB_DRIVER=pgsql
DB_HOST=__DB_HOST__
DB_PORT=5432
DB_DATABASE=ashchan
DB_USERNAME=ashchan
DB_PASSWORD=ashchan
DB_CHARSET=utf8
DB_POOL_SIZE=10

# ─────────────────────────────────────────────────────────────
# Redis (Cache, Queue, Rate Limiting)
# ─────────────────────────────────────────────────────────────
REDIS_HOST=__REDIS_HOST__
REDIS_PORT=6379
REDIS_PASSWORD=__REDIS_PASSWORD__
REDIS_AUTH=__REDIS_AUTH__
REDIS_DB=5
REDIS_POOL_SIZE=10

# ─────────────────────────────────────────────────────────────
# Rate Limiting Configuration
# ─────────────────────────────────────────────────────────────
RATE_LIMIT_ENABLED=true
RATE_LIMIT_WINDOW=60
RATE_LIMIT_MAX_REQUESTS=10
RATE_LIMIT_BURST=20

# ─────────────────────────────────────────────────────────────
# Anti-Spam Configuration
# ─────────────────────────────────────────────────────────────
# Risk scoring thresholds
SPAM_SCORE_THRESHOLD=0.7
QUARANTINE_SCORE_THRESHOLD=0.9

# Flood prevention
FLOOD_WINDOW=10
FLOOD_MAX_POSTS=3
FLOOD_COOLDOWN=60

# Link restrictions
LINKS_MAX_PER_POST=5
LINKS_NOFOLLOW_THRESHOLD=3

# ─────────────────────────────────────────────────────────────
# Ban Configuration
# ─────────────────────────────────────────────────────────────
BAN_CHECK_ENABLED=true
BAN_CACHE_TTL=300

# ─────────────────────────────────────────────────────────────
# Report Configuration
# ─────────────────────────────────────────────────────────────
REPORT_CATEGORIES_ENABLED=true
REPORT_AUTO_QUARANTINE=true
REPORT_THRESHOLD=3

# ─────────────────────────────────────────────────────────────
# Event Consumer Configuration
# ─────────────────────────────────────────────────────────────
EVENTS_STREAM_NAME=ashchan:events
EVENTS_DLQ_STREAM=ashchan:events:dlq
EVENTS_MAXLEN=100000
EVENTS_REDIS_DB=6
EVENTS_CONSUMER_GROUP=moderation
EVENTS_BATCH_SIZE=100
EVENTS_POLL_INTERVAL=1000
EVENTS_MAX_RETRIES=3

# ─────────────────────────────────────────────────────────────
# Logging
# ─────────────────────────────────────────────────────────────
LOG_LEVEL=info
LOG_FORMAT=json

# ─────────────────────────────────────────────────────────────
# Audit Logging
# ─────────────────────────────────────────────────────────────
AUDIT_LOG_ENABLED=true
AUDIT_LOG_RETENTION_DAYS=365

# ─────────────────────────────────────────────────────────────
# PII Encryption at Rest
# ─────────────────────────────────────────────────────────────
# Key for encrypting PII (IP addresses) at rest.
# MUST match the key used by boards-threads-posts service
# so SFS submissions can decrypt IPs stored by the boards service.
# Generate with: php -r "echo sodium_bin2hex(random_bytes(32));"
# REQUIRED in production. If empty, PII is stored in plaintext.
PII_ENCRYPTION_KEY=

# ─────────────────────────────────────────────────────────────
# StopForumSpam Integration
# ─────────────────────────────────────────────────────────────
# API key for reporting spammers to SFS (optional for read-only checks)
SFS_API_KEY=

# ─────────────────────────────────────────────────────────────
# Spur.us IP Intelligence (Context API)
# ─────────────────────────────────────────────────────────────
# API token from https://app.spur.us — required to enable Spur lookups.
# Runtime toggle: set 'spur_enabled' in site_settings table to 'true'.
# Without a valid token, Spur integration remains disabled regardless.
SPUR_API_TOKEN=
# Request timeout in seconds (default: 3)
SPUR_TIMEOUT=3
