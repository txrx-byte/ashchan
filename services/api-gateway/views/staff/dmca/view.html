<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMCA Notice #<?= $notice->id ?> - Staff Panel</title>
    <link rel="stylesheet" href="/staff/css/admincore.css">
    <link rel="stylesheet" href="/staff/css/bans.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Staff Panel</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="/staff/admin" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Overview</span>
                </a>
                <div class="nav-section">Moderation</div>
                <a href="/staff/reports" class="nav-item">
                    <span class="nav-icon">üö©</span>
                    <span>Reports Queue</span>
                </a>
                <a href="/staff/reports/ban-requests" class="nav-item">
                    <span class="nav-icon">‚öñÔ∏è</span>
                    <span>Ban Requests</span>
                </a>
                <a href="/staff/bans" class="nav-item">
                    <span class="nav-icon">üö´</span>
                    <span>Bans</span>
                </a>
                <div class="nav-section">Management</div>
                <a href="/staff/accounts" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Accounts</span>
                </a>
                <a href="/staff/capcodes" class="nav-item">
                    <span class="nav-icon">üè∑Ô∏è</span>
                    <span>Capcodes</span>
                </a>
                <a href="/staff/iprangebans" class="nav-item">
                    <span class="nav-icon">üåê</span>
                    <span>IP Range Bans</span>
                </a>
                <a href="/staff/autopurge" class="nav-item">
                    <span class="nav-icon">üóëÔ∏è</span>
                    <span>Autopurge</span>
                </a>
                <a href="/staff/dmca" class="nav-item active">
                    <span class="nav-icon">üìß</span>
                    <span>DMCA</span>
                </a>
                <a href="/staff/blotter" class="nav-item">
                    <span class="nav-icon">üì¢</span>
                    <span>Blotter</span>
                </a>
                <a href="/staff/site-messages" class="nav-item">
                    <span class="nav-icon">üìù</span>
                    <span>Site Messages</span>
                </a>
                <div class="nav-section">Account</div>
                <a href="/staff/logout" class="nav-item">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
            </nav>
        </aside>
        <main class="content">
            <header class="content-header">
                <h2>DMCA Notice #<?= $notice->id ?></h2>
                <a href="/staff/dmca" class="btn">Back to List</a>
            </header>

            <div class="detail-section">
                <h3>Claimant Information</h3>
                <dl class="detail-list">
                    <dt>Name</dt>
                    <dd><?= htmlspecialchars($notice->claimant_name) ?></dd>
                    
                    <dt>Company</dt>
                    <dd><?= htmlspecialchars($notice->claimant_company ?? 'N/A') ?></dd>
                    
                    <dt>Email</dt>
                    <dd><?= htmlspecialchars($notice->claimant_email) ?></dd>
                    
                    <dt>Phone</dt>
                    <dd><?= htmlspecialchars($notice->claimant_phone ?? 'N/A') ?></dd>
                </dl>
            </div>

            <div class="detail-section">
                <h3>Copyright Information</h3>
                <dl class="detail-list">
                    <dt>Copyrighted Work</dt>
                    <dd><?= nl2br(htmlspecialchars($notice->copyrighted_work)) ?></dd>
                    
                    <dt>Infringing URLs</dt>
                    <dd>
                        <ul class="url-list">
                            <?php 
                            $urls = is_array($notice->infringing_urls) ? $notice->infringing_urls : [];
                            foreach ($urls as $url): 
                            ?>
                                <li><a href="<?= htmlspecialchars($url) ?>" target="_blank" rel="noopener"><?= htmlspecialchars($url) ?></a></li>
                            <?php endforeach; ?>
                        </ul>
                    </dd>
                </dl>
            </div>

            <div class="detail-section">
                <h3>Legal Statement</h3>
                <div class="statement-box">
                    <?= nl2br(htmlspecialchars($notice->statement)) ?>
                </div>
                <?php if ($notice->signature): ?>
                    <p><strong>Signature:</strong> <?= htmlspecialchars($notice->signature) ?></p>
                <?php endif; ?>
            </div>

            <div class="detail-section">
                <h3>Status & Processing</h3>
                <form id="statusForm" class="inline-form">
                    <label>Status: 
                        <select name="status" onchange="updateStatus(<?= $notice->id ?>)">
                            <option value="pending" <?= $notice->status === 'pending' ? 'selected' : '' ?>>Pending</option>
                            <option value="processed" <?= $notice->status === 'processed' ? 'selected' : '' ?>>Processed</option>
                            <option value="rejected" <?= $notice->status === 'rejected' ? 'selected' : '' ?>>Rejected</option>
                        </select>
                    </label>
                </form>
                <p><strong>Received:</strong> <?= date('Y-m-d H:i:s', strtotime($notice->received_at)) ?></p>
                <?php if ($notice->processed_at): ?>
                    <p><strong>Processed:</strong> <?= date('Y-m-d H:i:s', strtotime($notice->processed_at)) ?></p>
                <?php endif; ?>
                <?php if ($notice->notes): ?>
                    <p><strong>Notes:</strong></p>
                    <div class="notes-box"><?= nl2br(htmlspecialchars($notice->notes)) ?></div>
                <?php endif; ?>
            </div>

            <?php if (!empty($takedowns)): ?>
                <div class="detail-section">
                    <h3>Takedowns (<?= count($takedowns) ?>)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Board</th>
                                <th>Post #</th>
                                <th>Reason</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($takedowns as $takedown): ?>
                                <tr>
                                    <td>/<?= htmlspecialchars($takedown->board) ?>/</td>
                                    <td><?= $takedown->post_no ?></td>
                                    <td><?= htmlspecialchars($takedown->takedown_reason ?? 'N/A') ?></td>
                                    <td><?= date('Y-m-d H:i', strtotime($takedown->takedown_at)) ?></td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>

            <div class="detail-section">
                <h3>Process Notice</h3>
                <form id="processForm" class="form">
                    <div class="form-group">
                        <label>Takedown Entries</label>
                        <div id="takedownEntries">
                            <div class="takedown-entry">
                                <input type="text" name="takedowns[0][board]" placeholder="Board (e.g., b)" style="width: 100px;">
                                <input type="number" name="takedowns[0][post_no]" placeholder="Post #" style="width: 120px;">
                                <input type="text" name="takedowns[0][reason]" placeholder="Reason" style="flex: 1;">
                                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">√ó</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm" onclick="addTakedownEntry()">+ Add Entry</button>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="3" placeholder="Internal notes..."><?= htmlspecialchars($notice->notes ?? '') ?></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Process Notice</button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    <script src="/staff/js/admincore.js"></script>
    <script>
        let takedownCount = 1;
        function addTakedownEntry() {
            const container = document.getElementById('takedownEntries');
            const div = document.createElement('div');
            div.className = 'takedown-entry';
            div.innerHTML = `
                <input type="text" name="takedowns[${takedownCount}][board]" placeholder="Board" style="width: 100px;">
                <input type="number" name="takedowns[${takedownCount}][post_no]" placeholder="Post #" style="width: 120px;">
                <input type="text" name="takedowns[${takedownCount}][reason]" placeholder="Reason" style="flex: 1;">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
            takedownCount++;
        }

        function updateStatus(id) {
            const form = document.getElementById('statusForm');
            const status = form.querySelector('select').value;
            fetch('/staff/dmca/' + id + '/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status }),
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    alert('Error: ' + data.error);
                }
            });
        }

        document.getElementById('processForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const takedowns = [];
            for (let i = 0; i < takedownCount; i++) {
                const board = formData.get('takedowns[' + i + '][board]');
                const postNo = formData.get('takedowns[' + i + '][post_no]');
                if (board && postNo) {
                    takedowns.push({
                        board: board,
                        post_no: postNo,
                        reason: formData.get('takedowns[' + i + '][reason]') || '',
                    });
                }
            }
            const data = {
                status: 'processed',
                notes: formData.get('notes'),
                takedowns: takedowns,
            };
            fetch('/staff/dmca/<?= $notice->id ?>/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        });
    </script>
</body>
</html>
