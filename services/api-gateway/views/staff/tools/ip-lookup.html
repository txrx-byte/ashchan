<!DOCTYPE html>
<!--
  Copyright 2026 txrx-byte

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<html>
<head>
  <meta charset="utf-8">
  <meta name="referrer" content="never">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>IP Lookup - Ashchan Staff</title>
  <link rel="stylesheet" type="text/css" href="/staff/css/admincore.css">
  <link rel="stylesheet" type="text/css" href="/staff/css/bans.css">
  <link rel="stylesheet" type="text/css" href="/staff/css/admin.css">
  <link rel="shortcut icon" href="/staff/favicon.ico" type="image/x-icon">
</head>
<body>
<nav id="admin-nav">
  <div class="admin-logo">Ashchan Admin</div>
  <ul class="nav-section">
    <li class="nav-header">Main</li>
    <li><a href="/staff/admin">Overview</a></li>
    <li><a href="/staff/dashboard">Dashboard</a></li>
  </ul>
  <ul class="nav-section">
    <li class="nav-header">Moderation</li>
    <li><a href="/staff/reports">Reports Queue</a></li>
    <li><a href="/staff/reports/ban-requests">Ban Requests</a></li>
    <li><a href="/staff/bans">Bans</a></li>
    <li><a href="/staff/ban-templates">Ban Templates</a></li>
    <li><a href="/staff/report-categories">Report Categories</a></li>
  </ul>
  <ul class="nav-section">
    <li class="nav-header">Search & Tools</li>
    <li><a href="/staff/search">Search</a></li>
    <li><a href="/staff/ip-lookup" class="active">IP Lookup</a></li>
    <li><a href="/staff/check-md5">Check MD5</a></li>
    <li><a href="/staff/check-filter">Check Filter</a></li>
  </ul>
  <ul class="nav-section nav-footer">
    <li><form method="POST" action="/staff/logout" style="display:inline"><button type="submit" class="logout" style="background:none;border:none;cursor:pointer;color:inherit;font:inherit;padding:0">Logout</button></form></li>
  </ul>
</nav>

<main id="admin-content">
<header class="content-header">
  <h1>IP Lookup</h1>
</header>

<div class="search-form-container">
  <form method="GET" action="/staff/ip-lookup" class="search-form">
    <input type="text" name="ip" placeholder="Enter IP address (e.g., 192.168.1.1)" value="<?= htmlspecialchars($ip ?? '') ?>" class="search-input" style="max-width: 400px;">
    <button type="submit" class="button button-primary">üîç Lookup</button>
  </form>
  <form method="GET" action="/staff/ip-lookup" class="search-form" style="margin-top: 10px;">
    <input type="text" name="hash" placeholder="Enter IP hash (16-char hex)" value="<?= htmlspecialchars($hash ?? '') ?>" class="search-input" style="max-width: 400px; font-family: monospace;">
    <button type="submit" class="button button-primary">üîç Hash Lookup</button>
  </form>
</div>

<?php if (!empty($hash_posts) && isset($hash_posts['posts'])): ?>
<div class="content-section">
  <h2>Post History for IP Hash: <code style="background:#f0f0f0;padding:2px 6px;border-radius:3px;font-size:14px;"><?= htmlspecialchars($hash) ?></code></h2>
  <p style="color:#666;margin-bottom:15px;"><?= (int)$hash_posts['count'] ?> post(s) found</p>
  
  <?php if (!empty($hash_posts['posts'])): ?>
  <table class="items-table">
    <thead>
      <tr>
        <th>Post ID</th>
        <th>Board</th>
        <th>Thread</th>
        <th>Name</th>
        <th>Subject</th>
        <th>Content Preview</th>
        <th>Media</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($hash_posts['posts'] as $post): ?>
      <tr>
        <td>
          <?php if (!empty($post['board_slug']) && !empty($post['thread_id'])): ?>
            <a href="/<?= htmlspecialchars($post['board_slug']) ?>/thread/<?= (int)$post['thread_id'] ?>#p<?= (int)$post['id'] ?>">#<?= (int)$post['id'] ?></a>
          <?php else: ?>
            #<?= (int)$post['id'] ?>
          <?php endif ?>
        </td>
        <td>/<?= htmlspecialchars($post['board_slug'] ?? '?') ?>/</td>
        <td>
          <?php if (!empty($post['board_slug']) && !empty($post['thread_id'])): ?>
            <a href="/<?= htmlspecialchars($post['board_slug']) ?>/thread/<?= (int)$post['thread_id'] ?>"><?= (int)$post['thread_id'] ?></a>
          <?php else: ?>
            <?= (int)($post['thread_id'] ?? 0) ?>
          <?php endif ?>
        </td>
        <td><?= htmlspecialchars($post['author_name'] ?? 'Anonymous') ?><?php if (!empty($post['tripcode'])): ?><span class="postertrip"><?= htmlspecialchars($post['tripcode']) ?></span><?php endif ?></td>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><?= htmlspecialchars($post['subject'] ?? '') ?></td>
        <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><?= htmlspecialchars($post['content_preview'] ?? '') ?></td>
        <td>
          <?php if (!empty($post['thumb_url'])): ?>
            <a href="<?= htmlspecialchars($post['media_url'] ?? '#') ?>" target="_blank">
              <img src="<?= htmlspecialchars($post['thumb_url']) ?>" alt="thumb" style="max-width:50px;max-height:50px;">
            </a>
          <?php else: ?>
            ‚Äî
          <?php endif ?>
        </td>
        <td style="white-space:nowrap;"><?= htmlspecialchars($post['formatted_time'] ?? '') ?></td>
      </tr>
      <?php endforeach ?>
    </tbody>
  </table>
  <?php else: ?>
  <p style="color: #666;">No posts found for this IP hash.</p>
  <?php endif ?>
</div>
<?php elseif (!empty($hash) && $hash_posts === null): ?>
<div class="empty-state">
  <div class="empty-icon">‚ùå</div>
  <h2>IP Hash Lookup Failed</h2>
  <p>Could not retrieve post history. The hash must be a 16-character hex string.</p>
</div>
<?php endif ?>

<?php if ($info !== null): ?>
<div class="content-section">
  <h2>IP Information: <?= htmlspecialchars($ip) ?></h2>
  
  <div class="ip-summary">
    <div class="summary-item">
      <span class="summary-label">Total Bans:</span>
      <span class="summary-value <?= $info['ban_count'] > 0 ? 'text-danger' : '' ?>"><?= $info['ban_count'] ?></span>
    </div>
    <div class="summary-item">
      <span class="summary-label">Total Reports:</span>
      <span class="summary-value <?= $info['report_count'] > 0 ? 'text-warning' : '' ?>"><?= $info['report_count'] ?></span>
    </div>
  </div>
  
  <?php if (!empty($info['bans'])): ?>
  <h3 style="margin-top: 20px;">Ban History</h3>
  <table class="items-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Board</th>
        <th>Reason</th>
        <th>Banned On</th>
        <th>Length</th>
        <th>Banned By</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($info['bans'] as $ban): ?>
      <tr>
        <td>#<?= $ban->id ?></td>
        <td>/<?= htmlspecialchars($ban->board ?: 'Global') ?>/</td>
        <td><?= htmlspecialchars($ban->reason ?? '') ?></td>
        <td><?= date('m/d/y H:i', strtotime($ban->now)) ?></td>
        <td><?= $ban->length ? 'Permanent' : 'Temporary' ?></td>
        <td><?= htmlspecialchars($ban->admin) ?></td>
        <td>
          <?php if ($ban->active): ?>
            <span class="badge badge-success">Active</span>
          <?php else: ?>
            <span class="badge badge-secondary">Expired</span>
          <?php endif ?>
        </td>
      </tr>
      <?php endforeach ?>
    </tbody>
  </table>
  <?php else: ?>
  <p style="margin-top: 20px; color: #666;">No bans found for this IP</p>
  <?php endif ?>
  
  <?php if (!empty($info['reports'])): ?>
  <h3 style="margin-top: 20px;">Recent Reports</h3>
  <table class="items-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Board</th>
        <th>Post No</th>
        <th>Time</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($info['reports'] as $report): ?>
      <tr>
        <td>#<?= $report->id ?></td>
        <td>/<?= htmlspecialchars($report->board) ?>/</td>
        <td>No.<?= $report->no ?></td>
        <td><?= date('m/d/y H:i', strtotime($report->ts)) ?></td>
        <td>
          <?php if ($report->cleared): ?>
            <span class="badge badge-success">Cleared</span>
          <?php else: ?>
            <span class="badge badge-warning">Pending</span>
          <?php endif ?>
        </td>
      </tr>
      <?php endforeach ?>
    </tbody>
  </table>
  <?php else: ?>
  <p style="margin-top: 20px; color: #666;">No reports found for this IP</p>
  <?php endif ?>
  
</div>
<?php elseif ($ip !== ''): ?>
<div class="empty-state">
  <div class="empty-icon">‚ùå</div>
  <h2>Invalid IP Address</h2>
  <p>Please enter a valid IPv4 or IPv6 address</p>
</div>
<?php else: ?>
<div class="content-section">
  <h2>IP Lookup Tool</h2>
  <p>Enter an IP address to view:</p>
  <ul class="search-tips">
    <li>Ban history for that IP</li>
    <li>Reports submitted from that IP</li>
    <li>User actions (posts, uploads)</li>
    <li>Geolocation information (if available)</li>
  </ul>
</div>
<?php endif ?>
</main>

<style>
.ip-summary {
  display: flex;
  gap: 30px;
  margin: 20px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}
.summary-item {
  display: flex;
  gap: 10px;
  align-items: center;
}
.summary-label {
  color: #666;
  font-size: 14px;
}
.summary-value {
  font-weight: bold;
  font-size: 20px;
}
.text-danger { color: #e74c3c; }
.text-warning { color: #f39c12; }
.badge-success { background: #27ae60; }
.badge-warning { background: #f39c12; }
.badge-secondary { background: #95a5a6; }
</style>
</body>
</html>
