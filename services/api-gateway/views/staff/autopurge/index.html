<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autopurge Rules - Staff Panel</title>
    <link rel="stylesheet" href="/staff/css/admincore.css">
    <link rel="stylesheet" href="/staff/css/bans.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Staff Panel</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="/staff/admin" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Overview</span>
                </a>
                <div class="nav-section">Moderation</div>
                <a href="/staff/reports" class="nav-item">
                    <span class="nav-icon">üö©</span>
                    <span>Reports Queue</span>
                </a>
                <a href="/staff/reports/ban-requests" class="nav-item">
                    <span class="nav-icon">‚öñÔ∏è</span>
                    <span>Ban Requests</span>
                </a>
                <a href="/staff/bans" class="nav-item">
                    <span class="nav-icon">üö´</span>
                    <span>Bans</span>
                </a>
                <div class="nav-section">Management</div>
                <a href="/staff/accounts" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Accounts</span>
                </a>
                <a href="/staff/capcodes" class="nav-item">
                    <span class="nav-icon">üè∑Ô∏è</span>
                    <span>Capcodes</span>
                </a>
                <a href="/staff/iprangebans" class="nav-item">
                    <span class="nav-icon">üåê</span>
                    <span>IP Range Bans</span>
                </a>
                <a href="/staff/autopurge" class="nav-item active">
                    <span class="nav-icon">üóëÔ∏è</span>
                    <span>Autopurge</span>
                </a>
                <a href="/staff/dmca" class="nav-item">
                    <span class="nav-icon">üìß</span>
                    <span>DMCA</span>
                </a>
                <a href="/staff/blotter" class="nav-item">
                    <span class="nav-icon">üì¢</span>
                    <span>Blotter</span>
                </a>
                <a href="/staff/site-messages" class="nav-item">
                    <span class="nav-icon">üìù</span>
                    <span>Site Messages</span>
                </a>
                <div class="nav-section">Account</div>
                <form method="POST" action="/staff/logout" class="nav-item" style="margin:0">
                    <button type="submit" style="background:none;border:none;cursor:pointer;color:inherit;font:inherit;padding:0;display:flex;align-items:center;gap:8px;width:100%">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                    </button>
                </form>
            </nav>
        </aside>
        <main class="content">
            <header class="content-header">
                <h2>Autopurge Rules</h2>
                <a href="/staff/autopurge/create" class="btn btn-primary">+ New Rule</a>
            </header>

            <div class="test-tool">
                <h3>Test Pattern</h3>
                <div class="test-form">
                    <input type="text" id="pattern" placeholder="Pattern to test">
                    <label><input type="checkbox" id="isRegex"> Regex</label>
                    <input type="text" id="sampleText" placeholder="Sample text to test against">
                    <button class="btn" onclick="testPattern()">Test</button>
                </div>
                <div id="testResult" class="test-result"></div>
            </div>

            <?php if (empty($rules)): ?>
                <div class="empty-state">
                    <p>No autopurge rules found.</p>
                </div>
            <?php else: ?>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Pattern</th>
                                <th>Type</th>
                                <th>Boards</th>
                                <th>Action</th>
                                <th>Ban</th>
                                <th>Hits</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($rules as $rule): ?>
                                <tr>
                                    <td>
                                        <code><?= htmlspecialchars($rule->pattern) ?></code>
                                    </td>
                                    <td>
                                        <?php if ($rule->is_regex): ?>
                                            <span class="badge badge-info">Regex</span>
                                        <?php else: ?>
                                            <span class="badge badge-secondary">Literal</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <?php if (empty($rule->boards)): ?>
                                            <em>All boards</em>
                                        <?php else: ?>
                                            <?= htmlspecialchars(implode(', ', $rule->boards)) ?>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <?php if ($rule->purge_threads && $rule->purge_replies): ?>
                                            Threads & Replies
                                        <?php elseif ($rule->purge_threads): ?>
                                            Threads only
                                        <?php elseif ($rule->purge_replies): ?>
                                            Replies only
                                        <?php else: ?>
                                            <em>None</em>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <?php if ($rule->ban_length_days > 0): ?>
                                            <?= $rule->ban_length_days ?> days
                                        <?php else: ?>
                                            <em>No ban</em>
                                        <?php endif; ?>
                                    </td>
                                    <td><?= $rule->hit_count ?? 0 ?></td>
                                    <td>
                                        <?php if ($rule->is_active): ?>
                                            <span class="badge badge-success">Active</span>
                                        <?php else: ?>
                                            <span class="badge badge-secondary">Inactive</span>
                                        <?php endif; ?>
                                    </td>
                                    <td class="actions">
                                        <a href="/staff/autopurge/<?= $rule->id ?>/edit" class="btn btn-sm">Edit</a>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRule(<?= $rule->id ?>)">Delete</button>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </main>
    </div>
    <script src="/staff/js/admincore.js"></script>
    <script>
        function deleteRule(id) {
            if (!confirm('Are you sure you want to delete this autopurge rule?')) return;
            fetch('/staff/autopurge/' + id + '/delete', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                });
        }

        function testPattern() {
            const pattern = document.getElementById('pattern').value.trim();
            const sampleText = document.getElementById('sampleText').value.trim();
            const isRegex = document.getElementById('isRegex').checked;

            if (!pattern) {
                alert('Please enter a pattern');
                return;
            }

            fetch('/staff/autopurge/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pattern, sample_text: sampleText, is_regex: isRegex }),
            })
            .then(r => r.json())
            .then(data => {
                const result = document.getElementById('testResult');
                if (data.error) {
                    result.innerHTML = '<p class="text-danger">Error: ' + data.error + '</p>';
                } else if (data.matched) {
                    result.innerHTML = '<p class="text-success">‚úì Pattern matched!</p>';
                } else {
                    result.innerHTML = '<p class="text-warning">‚úó Pattern did not match.</p>';
                }
            });
        }
    </script>
<script src="/staff/js/admincore.js"></script>
<script src="/staff/js/autopurge.js"></script>
</body>
</html>
