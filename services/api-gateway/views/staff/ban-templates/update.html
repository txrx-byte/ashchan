<!DOCTYPE html>
<!--
  Copyright 2026 txrx-byte

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<html>
<head>
  <meta charset="utf-8">
  <meta name="referrer" content="never">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title><?= $action === 'create' ? 'Add' : 'Edit' ?> Ban Template - Ashchan Staff</title>
  <link rel="stylesheet" type="text/css" href="/staff/css/admincore.css">
  <link rel="stylesheet" type="text/css" href="/staff/css/admin.css">
  <link rel="shortcut icon" href="/staff/favicon.ico" type="image/x-icon">
  <style>
    .form-grid { max-width:700px; margin:1rem auto; }
    .form-grid table { width:100%; border-collapse:collapse; }
    .form-grid th { text-align:right; padding:8px 12px 8px 0; vertical-align:top; width:160px; font-weight:600; font-size:0.9rem; color:#374151; }
    .form-grid td { padding:8px 0; }
    .form-grid input[type="text"],
    .form-grid input[type="number"],
    .form-grid textarea,
    .form-grid select { width:100%; padding:6px 10px; border:1px solid #d1d5db; border-radius:4px; font-size:0.9rem; }
    .form-grid textarea { font-family:inherit; }
    .form-grid select[multiple] { height:auto; min-height:120px; }
    .form-grid .note { font-size:0.8rem; color:#6b7280; margin-top:4px; }
    .form-grid .checkbox-group label { display:block; margin:4px 0; font-size:0.9rem; }
    .form-grid .checkbox-group input[type="checkbox"] { margin-right:6px; }
    .btn-submit { background:#3b82f6; color:#fff; border:none; padding:8px 24px; border-radius:4px; cursor:pointer; font-size:0.95rem; font-weight:600; }
    .btn-submit:hover { background:#2563eb; }
    .boards-help { font-size:0.8rem; color:#6b7280; margin-top:4px; }
    .board-scope-toggle { margin-bottom:8px; }
    .board-scope-toggle label { font-size:0.9rem; cursor:pointer; }
  </style>
</head>
<body>
<!-- Navigation Sidebar -->
<nav id="admin-nav">
  <div class="admin-logo">Ashchan Admin</div>
  <ul class="nav-section">
    <li class="nav-header">Main</li>
    <li><a href="/staff/admin">Overview</a></li>
    <li><a href="/staff/dashboard">Dashboard</a></li>
  </ul>
  <ul class="nav-section">
    <li class="nav-header">Moderation</li>
    <li><a href="/staff/reports">Reports Queue</a></li>
    <li><a href="/staff/reports/ban-requests">Ban Requests</a></li>
    <li><a href="/staff/bans">Bans</a></li>
    <li><a href="/staff/ban-templates" class="active">Ban Templates</a></li>
    <li><a href="/staff/report-categories">Report Categories</a></li>
  </ul>
  <ul class="nav-section nav-footer">
    <li><form method="POST" action="/staff/logout" style="display:inline"><button type="submit" class="logout" style="background:none;border:none;cursor:pointer;color:inherit;font:inherit;padding:0">Logout</button></form></li>
  </ul>
</nav>

<main id="admin-content">
<header class="content-header">
  <h1><?= $action === 'create' ? 'Add' : 'Edit' ?> Ban Template</h1>
  <div class="header-actions">
    <a href="/staff/ban-templates" class="button button-light">&larr; Back to Templates</a>
  </div>
</header>

<?php
  $selectedBoards = [];
  if ($template && !empty($template['boards'])) {
    $selectedBoards = array_map('trim', explode(',', (string) $template['boards']));
  }
  $isGlobal = empty($selectedBoards);
?>

<div class="form-grid">
<form action="/staff/ban-templates<?= $action === 'edit' && $template ? '/' . $template['id'] : '' ?>" method="POST">
  <table>
    <tr>
      <th>Name</th>
      <td><input type="text" name="name" value="<?= htmlspecialchars((string) ($template['name'] ?? '')) ?>" required></td>
    </tr>
    <tr>
      <th>Rule</th>
      <td>
        <select name="rule">
          <option value="global1" <?= ($template['rule'] ?? '') === 'global1' ? 'selected' : '' ?>>global1 - Illegal Content</option>
          <option value="global2" <?= ($template['rule'] ?? '') === 'global2' ? 'selected' : '' ?>>global2 - NSFW on WS</option>
          <option value="global3" <?= ($template['rule'] ?? '') === 'global3' ? 'selected' : '' ?>>global3 - Report Abuse</option>
          <option value="global4" <?= ($template['rule'] ?? '') === 'global4' ? 'selected' : '' ?>>global4 - Ban Evasion</option>
          <option value="global5" <?= ($template['rule'] ?? '') === 'global5' ? 'selected' : '' ?>>global5 - Spam</option>
          <option value="global6" <?= ($template['rule'] ?? '') === 'global6' ? 'selected' : '' ?>>global6 - Advertising</option>
        </select>
      </td>
    </tr>
    <tr>
      <th>Ban Type</th>
      <td>
        <select name="ban_type">
          <option value="local" <?= ($template['ban_type'] ?? '') === 'local' ? 'selected' : '' ?>>Local</option>
          <option value="global" <?= ($template['ban_type'] ?? '') === 'global' ? 'selected' : '' ?>>Global</option>
          <option value="zonly" <?= ($template['ban_type'] ?? '') === 'zonly' ? 'selected' : '' ?>>Unappealable (Z-Only)</option>
        </select>
      </td>
    </tr>
    <tr>
      <th>Ban Days</th>
      <td>
        <input type="number" name="ban_days" value="<?= htmlspecialchars((string)($template['ban_days'] ?? '1')) ?>" min="-1">
        <div class="note">-1 = Permanent, 0 = Warning only</div>
      </td>
    </tr>
    <tr>
      <th>Public Reason</th>
      <td><textarea name="public_reason" rows="3" required><?= htmlspecialchars((string) ($template['public_reason'] ?? '')) ?></textarea></td>
    </tr>
    <tr>
      <th>Private Reason</th>
      <td><textarea name="private_reason" rows="2"><?= htmlspecialchars((string) ($template['private_reason'] ?? '')) ?></textarea></td>
    </tr>
    <tr>
      <th>Board Scope</th>
      <td>
        <div class="board-scope-toggle">
          <label><input type="radio" name="board_scope" value="global" <?= $isGlobal ? 'checked' : '' ?> onchange="toggleBoardSelect()"> Global (all boards)</label>
          <label><input type="radio" name="board_scope" value="specific" <?= !$isGlobal ? 'checked' : '' ?> onchange="toggleBoardSelect()"> Specific boards only</label>
        </div>
        <div id="board-select-wrapper" style="<?= $isGlobal ? 'display:none' : '' ?>">
          <?php if (!empty($boards)): ?>
          <select name="boards[]" id="boards-select" multiple size="<?= min(count($boards), 10) ?>">
            <?php foreach ($boards as $slug): ?>
            <option value="<?= htmlspecialchars((string) $slug) ?>" <?= in_array($slug, $selectedBoards) ? 'selected' : '' ?>>/<?= htmlspecialchars((string) $slug) ?>/</option>
            <?php endforeach ?>
          </select>
          <div class="boards-help">Hold Ctrl/Cmd to select multiple boards. Leave empty for all boards.</div>
          <?php else: ?>
          <div class="note">No boards found in database. Template will apply to all boards.</div>
          <?php endif ?>
        </div>
      </td>
    </tr>
    <tr>
      <th>Action</th>
      <td>
        <select name="action">
          <option value="">(none)</option>
          <option value="quarantine" <?= ($template['action'] ?? '') === 'quarantine' ? 'selected' : '' ?>>Quarantine</option>
          <option value="revokepass_illegal" <?= ($template['action'] ?? '') === 'revokepass_illegal' ? 'selected' : '' ?>>Revoke Pass (Illegal)</option>
          <option value="delfile" <?= ($template['action'] ?? '') === 'delfile' ? 'selected' : '' ?>>Delete File</option>
          <option value="delall" <?= ($template['action'] ?? '') === 'delall' ? 'selected' : '' ?>>Delete All by IP</option>
        </select>
      </td>
    </tr>
    <tr>
      <th>Exclude</th>
      <td>
        <input type="text" name="exclude" value="<?= htmlspecialchars((string) ($template['exclude'] ?? '')) ?>" placeholder="__nofile__ or __nws__">
        <div class="note">__nofile__ = requires image, __nws__ = not on NSFW boards</div>
      </td>
    </tr>
    <tr>
      <th>Access Level</th>
      <td>
        <select name="access">
          <option value="janitor" <?= ($template['access'] ?? '') === 'janitor' ? 'selected' : '' ?>>Janitor</option>
          <option value="mod" <?= ($template['access'] ?? '') === 'mod' ? 'selected' : '' ?>>Moderator</option>
          <option value="manager" <?= ($template['access'] ?? '') === 'manager' ? 'selected' : '' ?>>Manager</option>
          <option value="admin" <?= ($template['access'] ?? '') === 'admin' ? 'selected' : '' ?>>Admin</option>
        </select>
      </td>
    </tr>
    <tr>
      <th>Options</th>
      <td class="checkbox-group">
        <label><input type="checkbox" name="publicban" <?= ($template['publicban'] ?? 0) ? 'checked' : '' ?>> Public Ban</label>
        <label><input type="checkbox" name="is_public" <?= ($template['is_public'] ?? 0) ? 'checked' : '' ?>> Display on ban page</label>
        <label><input type="checkbox" name="can_warn" <?= ($template['can_warn'] ?? 1) ? 'checked' : '' ?>> Can Warn</label>
        <label><input type="checkbox" name="appealable" <?= ($template['appealable'] ?? 1) ? 'checked' : '' ?>> Appealable</label>
        <label><input type="checkbox" name="blacklist_image" <?= ($template['blacklist_image'] ?? 0) ? 'checked' : '' ?>> Blacklist Image</label>
        <?php if ($action === 'edit'): ?>
        <label><input type="checkbox" name="active" <?= ($template['active'] ?? 1) ? 'checked' : '' ?>> Active</label>
        <?php endif ?>
      </td>
    </tr>
    <tr>
      <td></td>
      <td>
        <button class="btn-submit" type="submit"><?= $action === 'create' ? 'Create Template' : 'Save Changes' ?></button>
      </td>
    </tr>
  </table>
</form>
</div>
</main>

<script src="/staff/js/admincore.js"></script>
<script>
function toggleBoardSelect() {
  var scope = document.querySelector('input[name="board_scope"]:checked');
  var wrapper = document.getElementById('board-select-wrapper');
  var select = document.getElementById('boards-select');
  if (scope && scope.value === 'global') {
    wrapper.style.display = 'none';
    // Deselect all boards so the form submits empty
    if (select) {
      for (var i = 0; i < select.options.length; i++) {
        select.options[i].selected = false;
      }
    }
  } else {
    wrapper.style.display = '';
  }
}
</script>
</body>
</html>
