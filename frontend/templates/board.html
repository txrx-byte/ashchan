<!--
  Copyright 2026 txrx-byte

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

{% extends "layout.html" %}

{% block content %}

<!-- COPPA / Age Gate (shown first visit) -->
<noscript>
  <div class="noscriptWarning" style="text-align:center;padding:20px;background:#fca;margin:10px;">
    JavaScript is required for full functionality. Basic browsing works without it.
  </div>
</noscript>

<!-- Post Form Toggle -->
<div id="togglePostFormLink" class="center">
  [<a href="#" id="togglePostForm">Start a New Thread</a>]
</div>

<!-- Post Form -->
<div id="postForm" style="display:none;">
  <form id="mpostform" name="post" action="/api/v1/boards/{{ board_slug }}/threads" method="post" enctype="multipart/form-data">
    <table class="postForm">
      <tbody>
        <tr data-type="Name">
          <td class="label">Name</td>
          <td><input name="name" type="text" placeholder="Anonymous" autocomplete="off" maxlength="75"></td>
        </tr>
        <tr data-type="Options">
          <td class="label">Options</td>
          <td><input name="email" type="text" placeholder="sage" autocomplete="off" maxlength="75"></td>
        </tr>
        <tr data-type="Subject">
          <td class="label">Subject</td>
          <td>
            <input name="sub" type="text" autocomplete="off" maxlength="100">
            <input type="submit" value="Post">
          </td>
        </tr>
        <tr data-type="Comment">
          <td class="label">Comment</td>
          <td><textarea name="com" cols="48" rows="4" maxlength="2000" wrap="soft"></textarea></td>
        </tr>
        <tr data-type="File">
          <td class="label">File</td>
          <td>
            <input name="upfile" type="file" accept="image/jpeg,image/png,image/gif,image/webp">
            <label><input type="checkbox" name="spoiler"> Spoiler?</label>
          </td>
        </tr>
        <tr id="captchaRow" data-type="Captcha">
          <td class="label">Captcha</td>
          <td>
            <div id="t-root">
              <div id="captcha-container">
                <!-- Server-rendered captcha or hCaptcha widget -->
                <img id="captchaImg" src="/api/v1/captcha" alt="captcha" style="cursor:pointer" title="Click to refresh">
                <input name="captcha_response" type="text" placeholder="Type the text above" maxlength="8" autocomplete="off">
              </div>
            </div>
          </td>
        </tr>
        <tr data-type="Rules">
          <td colspan="2" class="rules">
            <ul>
              <li>Supported file types: JPEG, PNG, GIF, WebP (max 4MB)</li>
              <li>Images larger than 250x250 will be thumbnailed.</li>
              <li>Read the <a href="/rules">Rules</a> before posting.</li>
            </ul>
            <p class="privacy-notice" style="font-size: 11px; color: #888; margin: 4px 0 0 0;">
              By posting, you agree to our <a href="/legal/privacy" target="_blank">Privacy Policy</a>.
              Your IP is encrypted and auto-deleted after 30 days.
              Spam may be reported to <a href="https://www.stopforumspam.com" target="_blank" rel="noopener">SFS</a>.
            </p>
          </td>
        </tr>
      </tbody>
    </table>
  </form>
</div>
<div id="postFormError"></div>

<script>
(function() {
  var toggle = document.getElementById('togglePostForm');
  var form = document.getElementById('postForm');
  if (toggle && form) {
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      form.style.display = form.style.display === 'none' ? '' : 'none';
    });
  }
})();
</script>

<hr class="abovePostForm">

<!-- Board Subtitle / Flags -->
<div class="boardSubtitle">
  {% if board_subtitle %}<span>{{ board_subtitle }}</span>{% endif %}
</div>

<!-- Sorting Controls -->
<div class="sortControls" style="text-align:right;margin:0 5px 5px 0;font-size:10pt;">
  [<a href="/{{ board_slug }}/catalog">Catalog</a>]
  [<a href="/{{ board_slug }}/archive">Archive</a>]
  <span id="ctrl-top">
    [<a href="#bottom">Bottom</a>]
  </span>
</div>

<hr>

<!-- Threads -->
<form id="delform" name="delform" class="deleteform">
  {% for thread in threads %}
  <div class="thread" id="t{{ thread.id }}">

    <!-- OP Post -->
    <div class="postContainer opContainer" id="pc{{ thread.op.id }}">
      <div id="p{{ thread.op.id }}" class="post op">
        <div class="postInfo desktop" id="pi{{ thread.op.id }}">
          <input type="checkbox" name="{{ thread.op.id }}" value="delete">
          {% if thread.op.subject %}
            <span class="subject">{{ thread.op.subject }}</span>
          {% endif %}
          <span class="nameBlock">
            <span class="name">{{ thread.op.author_name|default('Anonymous') }}</span>
            {% if thread.op.tripcode %}
              <span class="postertrip">{{ thread.op.tripcode }}</span>
            {% endif %}
          </span>
          <span class="dateTime" data-utc="{{ thread.op.created_at }}">{{ thread.op.formatted_time }}</span>
          <span class="postNum desktop">
            <a href="/{{ board_slug }}/thread/{{ thread.id }}#p{{ thread.op.id }}" title="Link to this post">No.</a>
            <a href="/{{ board_slug }}/thread/{{ thread.id }}#q{{ thread.op.id }}" title="Reply to this post">{{ thread.op.id }}</a>
          </span>
          <span class="postMenuBtn" title="Post menu">▶</span>
          [<a href="/{{ board_slug }}/thread/{{ thread.id }}" class="replylink">Reply</a>]
        </div>

        {% if thread.op.media_url %}
        <div class="file" id="f{{ thread.op.id }}">
          <div class="fileText" id="fT{{ thread.op.id }}">
            File: <a href="{{ thread.op.media_url }}" target="_blank">{{ thread.op.media_filename }}</a>
            ({{ thread.op.media_size_human }}, {{ thread.op.media_dimensions }})
          </div>
          <a class="fileThumb" href="{{ thread.op.media_url }}" target="_blank">
            <img src="{{ thread.op.thumb_url }}" alt="{{ thread.op.media_size_human }}" loading="lazy"
                 style="max-width:250px;max-height:250px;">
          </a>
        </div>
        {% endif %}

        <blockquote class="postMessage" id="m{{ thread.op.id }}">
          {{ thread.op.content_html|safe }}
        </blockquote>
      </div>
    </div>

    <!-- Omitted info -->
    {% if thread.omitted_posts > 0 %}
    <span class="summary desktop">
      <span class="info">{{ thread.omitted_posts }} post{{ 's' if thread.omitted_posts > 1 }}
      {% if thread.omitted_images > 0 %}and {{ thread.omitted_images }} image reply{{ 's' if thread.omitted_images > 1 }}{% endif %}
      omitted. <a href="/{{ board_slug }}/thread/{{ thread.id }}">Click here</a> to view.
      </span>
    </span>
    {% endif %}

    <!-- Latest Replies (preview on board index) -->
    {% for reply in thread.latest_replies %}
    <div class="postContainer replyContainer" id="pc{{ reply.id }}">
      <div class="sideArrows" id="sa{{ reply.id }}">&gt;&gt;</div>
      <div id="p{{ reply.id }}" class="post reply">
        <div class="postInfo desktop" id="pi{{ reply.id }}">
          <input type="checkbox" name="{{ reply.id }}" value="delete">
          <span class="nameBlock">
            <span class="name">{{ reply.author_name|default('Anonymous') }}</span>
            {% if reply.tripcode %}
              <span class="postertrip">{{ reply.tripcode }}</span>
            {% endif %}
          </span>
          <span class="dateTime" data-utc="{{ reply.created_at }}">{{ reply.formatted_time }}</span>
          <span class="postNum desktop">
            <a href="/{{ board_slug }}/thread/{{ thread.id }}#p{{ reply.id }}" title="Link to this post">No.</a>
            <a href="/{{ board_slug }}/thread/{{ thread.id }}#q{{ reply.id }}" title="Reply to this post">{{ reply.id }}</a>
          </span>
          <span class="postMenuBtn" title="Post menu">▶</span>
        </div>

        {% if reply.media_url %}
        <div class="file" id="f{{ reply.id }}">
          <div class="fileText" id="fT{{ reply.id }}">
            File: <a href="{{ reply.media_url }}" target="_blank">{{ reply.media_filename }}</a>
            ({{ reply.media_size_human }})
          </div>
          <a class="fileThumb" href="{{ reply.media_url }}" target="_blank">
            <img src="{{ reply.thumb_url }}" alt="{{ reply.media_size_human }}" loading="lazy"
                 style="max-width:125px;max-height:125px;">
          </a>
        </div>
        {% endif %}

        <blockquote class="postMessage" id="m{{ reply.id }}">
          {{ reply.content_html|safe }}
        </blockquote>
      </div>
    </div>
    {% endfor %}

  </div>
  <hr>
  {% endfor %}

  <!-- Delete / Report Controls (bottom) -->
  <div class="deleteform-controls" id="ctrl-bottom">
    <span class="deleteBtn">
      Delete Post
      [<label><input type="checkbox" name="onlyimgdel"> File Only</label>]
      Password <input type="password" name="pwd" id="delPassword" maxlength="8" size="8">
      <input type="submit" value="Delete">
    </span>
    [<input type="button" value="Report" onclick="alert('Select a post first')">]
  </div>
</form>

<hr>

<!-- Pagination -->
<div class="pagelist desktop" id="pagelist">
  <div class="pages">
    {% if page_num > 1 %}
      <a href="/{{ board_slug }}/{{ page_num - 1 }}" class="prev">&lt;&lt; Previous</a>
    {% endif %}
    {% for p in range(1, total_pages + 1) %}
      {% if p == page_num %}
        <strong>[{{ p }}]</strong>
      {% else %}
        <a href="/{{ board_slug }}/{{ p }}">[{{ p }}]</a>
      {% endif %}
    {% endfor %}
    {% if page_num < total_pages %}
      <a href="/{{ board_slug }}/{{ page_num + 1 }}" class="next">Next &gt;&gt;</a>
    {% endif %}
  </div>
</div>

<a id="bottom"></a>

{% endblock %}
