<!--
  Copyright 2026 txrx-byte

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

{% extends "layout.html" %}

{% block content %}

<!-- COPPA / Age Gate (shown first visit) -->
<noscript>
  <div class="noscriptWarning" style="text-align:center;padding:20px;background:#fca;margin:10px;">
    <span data-i18n="noscript.warning">JavaScript is required for full functionality. Basic browsing works without it.</span>
  </div>
</noscript>

<!-- Post Form Toggle -->
<div id="togglePostFormLink" class="center">
  [<a href="#" id="togglePostForm" data-i18n="form.newThread">Start a New Thread</a>]
</div>

<!-- Post Form -->
<div id="postForm" style="display:none;">
  <form id="mpostform" name="post" action="/{{ board_slug }}/threads" method="post" enctype="multipart/form-data">
    <table class="postForm">
      <tbody>
        <tr data-type="Name">
          <td class="label" data-i18n="form.name">Name</td>
          <td><input name="name" type="text" data-i18n-placeholder="form.placeholder.name" placeholder="Anonymous" autocomplete="off" maxlength="75"></td>
        </tr>
        <tr data-type="Options">
          <td class="label" data-i18n="form.options">Options</td>
          <td><input name="email" type="text" data-i18n-placeholder="form.placeholder.options" placeholder="sage" autocomplete="off" maxlength="75"></td>
        </tr>
        <tr data-type="Subject">
          <td class="label" data-i18n="form.subject">Subject</td>
          <td>
            <input name="sub" type="text" autocomplete="off" maxlength="100">
            <input type="submit" data-i18n-value="form.submit" value="Post">
          </td>
        </tr>
        <tr data-type="Comment">
          <td class="label" data-i18n="form.comment">Comment</td>
          <td><textarea name="com" cols="48" rows="4" maxlength="2000" wrap="soft"></textarea></td>
        </tr>
        <tr data-type="File">
          <td class="label" data-i18n="form.file">File</td>
          <td>
            <input name="upfile" type="file" accept="image/jpeg,image/png,image/gif,image/webp">
            <label><input type="checkbox" name="spoiler"> <span data-i18n="form.spoiler">Spoiler?</span></label>
          </td>
        </tr>
        <tr id="captchaRow" data-type="Verification">
          <td class="label" data-i18n="form.verification">Verification</td>
          <td>
            <div id="t-root">
              <altcha-widget
                challengeurl="/api/v1/altcha/challenge"
                name="altcha"
                hidefooter
                hidelogo
                auto="onsubmit"
              ></altcha-widget>
            </div>
          </td>
        </tr>
        <tr data-type="Rules">
          <td colspan="2" class="rules">
            <ul>
              <li data-i18n="form.rules.filetypes">Supported file types: JPEG, PNG, GIF, WebP (max 4MB)</li>
              <li data-i18n="form.rules.thumbnail">Images larger than 250x250 will be thumbnailed.</li>
              <li data-i18n-html="form.rules.readRules">Read the <a href="/rules">Rules</a> before posting.</li>
            </ul>
            <p class="privacy-notice" style="font-size: 11px; color: #888; margin: 4px 0 0 0;" data-i18n-html="form.privacy">
              By posting, you agree to our <a href="/legal/privacy" target="_blank" rel="noopener noreferrer">Privacy Policy</a>.
              Your IP is encrypted and auto-deleted after 30 days.
              Spam may be reported to <a href="https://www.stopforumspam.com" target="_blank" rel="noopener noreferrer">SFS</a>.
            </p>
          </td>
        </tr>
      </tbody>
    </table>
  </form>
</div>
<div id="postFormError"></div>

<script>
(function() {
  var toggle = document.getElementById('togglePostForm');
  var form = document.getElementById('postForm');
  if (toggle && form) {
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      form.style.display = form.style.display === 'none' ? '' : 'none';
    });
  }
})();
</script>

<hr class="abovePostForm">

<!-- Board Subtitle / Flags -->
<div class="boardSubtitle">
  {% if board_subtitle %}<span>{{ board_subtitle }}</span>{% endif %}
</div>

<!-- Sorting Controls -->
<div class="sortControls" style="text-align:right;margin:0 5px 5px 0;font-size:10pt;">
  [<a href="/{{ board_slug }}/catalog" data-i18n="nav.catalog">Catalog</a>]
  [<a href="/{{ board_slug }}/archive" data-i18n="nav.archive">Archive</a>]
  <span id="ctrl-top">
    [<a href="#bottom" data-i18n="nav.bottom">Bottom</a>]
  </span>
</div>

<hr>

<!-- Threads -->
<form id="delform" name="delform" class="deleteform">
  {% for thread in threads %}
  <div class="thread" id="t{{ thread.id }}">

    <!-- OP Post -->
    <div class="postContainer opContainer" id="pc{{ thread.op.id }}">
      <div id="p{{ thread.op.id }}" class="post op">
        <div class="postInfo desktop" id="pi{{ thread.op.id }}">
          <input type="checkbox" name="{{ thread.op.id }}" value="delete">
          {% if thread.op.subject %}
            <span class="subject">{{ thread.op.subject }}</span>
          {% endif %}
          <span class="nameBlock">
            <span class="name">{{ thread.op.author_name|default('Anonymous') }}</span>
            {% if thread.op.tripcode %}
              <span class="postertrip">{{ thread.op.tripcode }}</span>
            {% endif %}
            {% if thread.op.capcode %}<span class="capcode">## {{ thread.op.capcode }}</span>{% endif %}
            {% if country_flags and thread.op.country_code %}<span class="flag flag-{{ thread.op.country_code|lower }}" title="{{ thread.op.country_name|default(thread.op.country_code) }}"></span>{% endif %}
            {% if user_ids and thread.op.poster_id %}<span class="posteruid id_{{ thread.op.poster_id }}"> (ID: <span class="hand" title="Highlight posts by this ID">{{ thread.op.poster_id }}</span>)</span>{% endif %}
            {% if is_staff and thread.op.ip_hash %}<span class="staff-ip-hash"> [<a href="/staff/ip-lookup?hash={{ thread.op.ip_hash }}" class="ip-hash-link" title="View post history for this IP hash">{{ thread.op.ip_hash }}</a>]</span>{% endif %}
          </span>
          <span class="dateTime" data-utc="{{ thread.op.created_at }}">{{ thread.op.formatted_time }}</span>
          <span class="postNum desktop">
            <a href="/{{ board_slug }}/thread/{{ thread.id }}#p{{ thread.op.id }}" data-i18n-title="post.linkPost" title="Link to this post">No.</a>
            <a href="/{{ board_slug }}/thread/{{ thread.id }}#q{{ thread.op.id }}" data-i18n-title="post.replyPost" title="Reply to this post">{{ thread.op.id }}</a>
          </span>
          <span class="postMenuBtn" data-i18n-title="post.postMenu" title="Post menu">▶</span>
          [<a href="/{{ board_slug }}/thread/{{ thread.id }}" class="replylink" data-i18n="board.reply">Reply</a>]
        </div>

        {% if thread.op.media_url %}
        <div class="file" id="f{{ thread.op.id }}">
          <div class="fileText" id="fT{{ thread.op.id }}">
            File: <a href="{{ thread.op.media_url }}" target="_blank" rel="noopener noreferrer">{{ thread.op.media_filename }}</a>
            ({{ thread.op.media_size_human }}, {{ thread.op.media_dimensions }})
          </div>
          <a class="fileThumb" href="{{ thread.op.media_url }}" target="_blank" rel="noopener noreferrer">
            <img src="{{ thread.op.thumb_url }}" alt="{{ thread.op.media_size_human }}" loading="lazy"
                 style="max-width:250px;max-height:250px;">
          </a>
        </div>
        {% endif %}

        <blockquote class="postMessage" id="m{{ thread.op.id }}">
          {{ thread.op.content_html|safe }}
        </blockquote>
      </div>
    </div>

    <!-- Omitted info -->
    {% if thread.omitted_posts > 0 %}
    <span class="summary desktop">
      <span class="info">{{ thread.omitted_posts }} post{{ 's' if thread.omitted_posts > 1 }}
      {% if thread.omitted_images > 0 %}and {{ thread.omitted_images }} image reply{{ 's' if thread.omitted_images > 1 }}{% endif %}
      omitted. <a href="/{{ board_slug }}/thread/{{ thread.id }}">Click here</a> to view.
      </span>
    </span>
    {% endif %}

    <!-- Latest Replies (preview on board index) -->
    {% for reply in thread.latest_replies %}
    <div class="postContainer replyContainer" id="pc{{ reply.id }}">
      <div class="sideArrows" id="sa{{ reply.id }}">&gt;&gt;</div>
      <div id="p{{ reply.id }}" class="post reply">
        <div class="postInfo desktop" id="pi{{ reply.id }}">
          <input type="checkbox" name="{{ reply.id }}" value="delete">
          <span class="nameBlock">
            <span class="name">{{ reply.author_name|default('Anonymous') }}</span>
            {% if reply.tripcode %}
              <span class="postertrip">{{ reply.tripcode }}</span>
            {% endif %}
            {% if reply.capcode %}<span class="capcode">## {{ reply.capcode }}</span>{% endif %}
            {% if country_flags and reply.country_code %}<span class="flag flag-{{ reply.country_code|lower }}" title="{{ reply.country_name|default(reply.country_code) }}"></span>{% endif %}
            {% if user_ids and reply.poster_id %}<span class="posteruid id_{{ reply.poster_id }}"> (ID: <span class="hand" title="Highlight posts by this ID">{{ reply.poster_id }}</span>)</span>{% endif %}
            {% if is_staff and reply.ip_hash %}<span class="staff-ip-hash"> [<a href="/staff/ip-lookup?hash={{ reply.ip_hash }}" class="ip-hash-link" title="View post history for this IP hash">{{ reply.ip_hash }}</a>]</span>{% endif %}
          </span>
          <span class="dateTime" data-utc="{{ reply.created_at }}">{{ reply.formatted_time }}</span>
          <span class="postNum desktop">
            <a href="/{{ board_slug }}/thread/{{ thread.id }}#p{{ reply.id }}" data-i18n-title="post.linkPost" title="Link to this post">No.</a>
            <a href="/{{ board_slug }}/thread/{{ thread.id }}#q{{ reply.id }}" data-i18n-title="post.replyPost" title="Reply to this post">{{ reply.id }}</a>
          </span>
          <span class="postMenuBtn" data-i18n-title="post.postMenu" title="Post menu">▶</span>
        </div>

        {% if reply.media_url %}
        <div class="file" id="f{{ reply.id }}">
          <div class="fileText" id="fT{{ reply.id }}">
            File: <a href="{{ reply.media_url }}" target="_blank" rel="noopener noreferrer">{{ reply.media_filename }}</a>
            ({{ reply.media_size_human }})
          </div>
          <a class="fileThumb" href="{{ reply.media_url }}" target="_blank" rel="noopener noreferrer">
            <img src="{{ reply.thumb_url }}" alt="{{ reply.media_size_human }}" loading="lazy"
                 style="max-width:125px;max-height:125px;">
          </a>
        </div>
        {% endif %}

        <blockquote class="postMessage" id="m{{ reply.id }}">
          {{ reply.content_html|safe }}
        </blockquote>
      </div>
    </div>
    {% endfor %}

  </div>
  <hr>
  {% endfor %}

  <!-- Delete / Report Controls (bottom) -->
  <div class="deleteform-controls" id="ctrl-bottom">
    <span class="deleteBtn">
      <span data-i18n="action.deletePost">Delete Post</span>
      [<label><input type="checkbox" name="onlyimgdel"> <span data-i18n="action.fileOnly">File Only</span></label>]
      <span data-i18n="action.password">Password</span> <input type="password" name="pwd" id="delPassword" maxlength="8" size="8">
      <input type="submit" data-i18n-value="action.delete" value="Delete">
    </span>
    [<input type="button" data-i18n-value="action.report" value="Report" onclick="alert('Select a post first')">]
  </div>
</form>

<hr>

<!-- Pagination -->
<div class="pagelist desktop" id="pagelist">
  <div class="pages">
    {% if page_num > 1 %}
      <a href="/{{ board_slug }}/{{ page_num - 1 }}" class="prev" data-i18n="pagination.prev">&lt;&lt; Previous</a>
    {% endif %}
    {% for p in range(1, total_pages + 1) %}
      {% if p == page_num %}
        <strong>[{{ p }}]</strong>
      {% else %}
        <a href="/{{ board_slug }}/{{ p }}">[{{ p }}]</a>
      {% endif %}
    {% endfor %}
    {% if page_num < total_pages %}
      <a href="/{{ board_slug }}/{{ page_num + 1 }}" class="next" data-i18n="pagination.next">Next &gt;&gt;</a>
    {% endif %}
  </div>
</div>

<a id="bottom"></a>

{% endblock %}
