# ═══════════════════════════════════════════════════════════════
# Ashchan — Nginx Front-End Configuration
# ═══════════════════════════════════════════════════════════════
#
# Architecture:  Cloudflare Tunnel → nginx (80) → Anubis (8080) → Varnish (6081) → API Gateway (9501)
#
# The origin server has NO public IP. All traffic arrives via
# Cloudflare Tunnel (cloudflared). TLS is terminated at
# Cloudflare's edge; nginx receives plain HTTP from cloudflared.
#
# This config provides:
#   - TLS termination with modern ciphers (TLS 1.2+/1.3)
#   - HTTP/2 and HTTP/3 (QUIC) support
#   - Anti-spam / anti-abuse rate limiting
#   - Connection limits per IP
#   - Request body size limits
#   - Security headers (CSP, HSTS, X-Frame-Options, etc.)
#   - Bot filtering via user-agent blocking
#   - Slowloris / slow-read mitigation
#   - Static asset caching (bypass Anubis for performance)
#   - WebSocket upgrade support
#   - Real IP forwarding to Anubis → Gateway chain
#   - Cloudflare integration (Authenticated Origin Pulls + real IP restore)
#   - Gzip/Brotli compression
#   - Structured access logging (privacy-safe: no raw IPs)
#
# Usage:
#   1. Copy to /etc/nginx/nginx.conf  (or include from sites-enabled/)
#   2. Update server_name with your domain
#   3. Update ssl_certificate / ssl_certificate_key paths
#   4. For Cloudflare: run  ./ashchan nginx:cloudflare
#   5. sudo nginx -t && sudo systemctl reload nginx
#
# See: docs/NGINX_HARDENING.md for full guidance
# ═══════════════════════════════════════════════════════════════

# ── Worker tuning ────────────────────────────────────────────
user                 www-data;
worker_processes     auto;
worker_rlimit_nofile 65535;
pid                  /run/nginx.pid;
error_log            /var/log/nginx/error.log warn;

events {
    worker_connections 8192;
    multi_accept       on;
    use                epoll;
}

http {
    # ── Basic ────────────────────────────────────────────────
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    charset       utf-8;

    sendfile           on;
    tcp_nopush         on;
    tcp_nodelay        on;
    server_tokens      off;
    more_clear_headers Server;

    # ── Timeouts (Slowloris / slow-read mitigation) ──────────
    client_header_timeout   10s;
    client_body_timeout     10s;
    send_timeout            10s;
    keepalive_timeout       30s;
    keepalive_requests      200;
    reset_timedout_connection on;

    # ── Body limits ──────────────────────────────────────────
    # 20 MB max for media uploads; Anubis/gateway enforce per-route
    client_max_body_size    20m;
    client_body_buffer_size 128k;

    # ── Header limits ────────────────────────────────────────
    large_client_header_buffers 4 8k;

    # ── Temp paths ───────────────────────────────────────────
    client_body_temp_path /var/lib/nginx/body 1 2;
    proxy_temp_path       /var/lib/nginx/proxy 1 2;

    # ── Logging (privacy-safe: no raw IPs in prod) ───────────
    # Hash or omit client IPs — see docs/DATA_INVENTORY.md
    log_format ashchan
        '$remote_addr - $remote_user [$time_local] '
        '"$request" $status $body_bytes_sent '
        '"$http_referer" "$http_user_agent" '
        'rt=$request_time uct=$upstream_connect_time '
        'urt=$upstream_response_time';

    access_log /var/log/nginx/access.log ashchan buffer=16k flush=5s;

    # ── Rate limiting zones ──────────────────────────────────
    # General requests: 30 req/s per IP with burst
    limit_req_zone  $binary_remote_addr zone=general:10m    rate=30r/s;

    # POST endpoints (thread/post creation): 2 req/s per IP
    limit_req_zone  $binary_remote_addr zone=posting:10m    rate=2r/s;

    # Auth endpoints (login/register): 5 req/min per IP
    limit_req_zone  $binary_remote_addr zone=auth:10m       rate=5r/m;

    # Static assets: generous limit
    limit_req_zone  $binary_remote_addr zone=static:5m      rate=60r/s;

    # ── Connection limiting ──────────────────────────────────
    limit_conn_zone $binary_remote_addr zone=perip:10m;

    # Error pages for rate limits (429)
    limit_req_status  429;
    limit_conn_status 429;

    # ── Upstream: Anubis AI Firewall ─────────────────────────
    upstream anubis {
        server 127.0.0.1:8080;

        # Connection pooling for performance
        keepalive 32;
        keepalive_requests 1000;
        keepalive_timeout  60s;
    }

    # ── Upstream: API Gateway (direct, for static assets) ────
    upstream gateway_direct {
        server 127.0.0.1:9501;

        keepalive 16;
        keepalive_requests 500;
        keepalive_timeout  60s;
    }

    # ── Gzip compression ─────────────────────────────────────
    gzip             on;
    gzip_vary        on;
    gzip_proxied     any;
    gzip_comp_level  4;
    gzip_min_length  256;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/xml+rss
        image/svg+xml;

    # ── Cloudflare real IP restoration ────────────────────────
    # When behind Cloudflare, $remote_addr is a CF edge IP.
    # These directives restore the true client IP from
    # CF-Connecting-IP so rate limiting, logging, and
    # downstream X-Forwarded-For all reference the real visitor.
    #
    # Without this, every visitor appears to share a handful of
    # Cloudflare edge IPs — rate limits would fire on all users
    # behind the same edge, logs would be unforgeable, and
    # admin ban/audit tools could not identify individuals.
    #
    # To keep this list current, run:  ./ashchan nginx:cloudflare
    # (or:  curl -s https://www.cloudflare.com/ips-v4 https://www.cloudflare.com/ips-v6)
    #
    # ── Cloudflare IPv4 ranges ──
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    # ── Cloudflare IPv6 ranges ──
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    # ── Use CF-Connecting-IP as the source of truth ──
    real_ip_header    CF-Connecting-IP;
    real_ip_recursive on;

    # ── Map: detect WebSocket upgrade ────────────────────────
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # ── Map: block abusive user-agents ───────────────────────
    map $http_user_agent $bad_bot {
        default 0;
        ~*(?:AhrefsBot|MJ12bot|SemrushBot|DotBot|BLEXBot)           1;
        ~*(?:MegaIndex|Sogou|YandexBot|PetalBot|Bytespider)         1;
        ~*(?:GPTBot|CCBot|ChatGPT-User|Google-Extended|FacebookBot)  1;
        ~*(?:ClaudeBot|anthropic-ai|cohere-ai|Perplexity)            1;
        ~*(?:Scrapy|Nutch|DataForSeoBot|Riddler|Seekport)            1;
        ''                                                           1;
    }

    # ══════════════════════════════════════════════════════════
    # HTTP → HTTPS redirect
    # ══════════════════════════════════════════════════════════
    server {
        listen      80 default_server;
        listen      [::]:80 default_server;
        server_name _;

        # ACME challenge for Let's Encrypt / certbot
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
            allow all;
        }

        # Redirect everything else to HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # ══════════════════════════════════════════════════════════
    # HTTPS — Main site
    # ══════════════════════════════════════════════════════════
    server {
        listen      443 ssl http2;
        listen      [::]:443 ssl http2;
        # Uncomment for HTTP/3 (requires nginx 1.25+ with quic module):
        # listen      443 quic reuseport;
        # listen      [::]:443 quic reuseport;

        # ── CHANGEME: Your domain ────────────────────────────
        server_name ashchan.example.com;

        # ── TLS ──────────────────────────────────────────────
        # CHANGEME: paths to your certificate and key
        ssl_certificate     /etc/letsencrypt/live/ashchan.example.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/ashchan.example.com/privkey.pem;

        # Modern TLS (1.2 + 1.3 only)
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
        ssl_prefer_server_ciphers off;

        # ── Cloudflare Authenticated Origin Pulls ────────────
        # This verifies that EVERY request arriving at this server
        # was sent by Cloudflare, not by an attacker who discovered
        # the origin IP. Cloudflare signs each request with a client
        # certificate issued from their Origin Pull CA. Without this,
        # anyone who finds your server's real IP can bypass Cloudflare
        # entirely — defeating WAF, DDoS protection, and rate limits.
        #
        # To enable:
        #   1. Download the CA:  ./ashchan nginx:cloudflare
        #   2. Uncomment the two lines below
        #   3. In Cloudflare dashboard → SSL/TLS → Origin Server:
        #      enable "Authenticated Origin Pulls"
        #
        # ssl_client_certificate /etc/nginx/certs/cloudflare-origin.pem;
        # ssl_verify_client on;

        # OCSP stapling
        ssl_stapling        on;
        ssl_stapling_verify on;
        resolver            1.1.1.1 8.8.8.8 valid=300s;
        resolver_timeout    5s;

        # Session resumption
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;

        # DH parameters (generate: openssl dhparam -out /etc/nginx/dhparam.pem 2048)
        # ssl_dhparam       /etc/nginx/dhparam.pem;

        # ── Security headers ─────────────────────────────────
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        add_header X-Frame-Options           "SAMEORIGIN"                                   always;
        add_header X-Content-Type-Options    "nosniff"                                      always;
        add_header X-XSS-Protection          "1; mode=block"                                always;
        add_header Referrer-Policy            "strict-origin-when-cross-origin"              always;
        add_header Permissions-Policy         "camera=(), microphone=(), geolocation=()"     always;
        add_header Content-Security-Policy    "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' wss:; frame-ancestors 'self';" always;
        # Uncomment for HTTP/3:
        # add_header Alt-Svc 'h3=":443"; ma=86400' always;

        # ── Connection limits ────────────────────────────────
        limit_conn perip 50;

        # ── Bot blocking ─────────────────────────────────────
        if ($bad_bot) {
            return 403;
        }

        # ── Static assets (bypass Anubis for speed) ──────────
        # CSS, JS, images served directly from gateway
        location /static/ {
            limit_req zone=static burst=30 nodelay;

            proxy_pass http://gateway_direct;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Preserve Cloudflare geo/IP headers for admin audit trail
            proxy_set_header CF-Connecting-IP  $http_cf_connecting_ip;
            proxy_set_header CF-IPCountry      $http_cf_ipcountry;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # Cache static assets aggressively
            proxy_cache_valid 200 1h;
            expires 7d;
            add_header Cache-Control "public, immutable";
        }

        # ── Media assets (bypass Anubis) ─────────────────────
        location /media/ {
            limit_req zone=static burst=30 nodelay;

            proxy_pass http://gateway_direct;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header CF-Connecting-IP  $http_cf_connecting_ip;
            proxy_set_header CF-IPCountry      $http_cf_ipcountry;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_cache_valid 200 30m;
            expires 1d;
            add_header Cache-Control "public";
        }

        # ── Health check (bypass Anubis) ─────────────────────
        location = /health {
            proxy_pass http://gateway_direct;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            access_log off;
        }

        # ── Auth endpoints (strict rate limit) ───────────────
        location ~ ^/api/v1/(auth|login|register) {
            limit_req zone=auth burst=3 nodelay;

            proxy_pass http://anubis;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header CF-Connecting-IP  $http_cf_connecting_ip;
            proxy_set_header CF-IPCountry      $http_cf_ipcountry;

            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # ── Post/thread creation (anti-spam rate limit) ──────
        location ~ ^/api/v1/boards/.+/(threads|posts) {
            limit_req zone=posting burst=5 nodelay;

            proxy_pass http://anubis;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header CF-Connecting-IP  $http_cf_connecting_ip;
            proxy_set_header CF-IPCountry      $http_cf_ipcountry;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # Allow upload body for media attachments
            client_max_body_size 20m;
        }

        # ── WebSocket endpoint (liveposting) ────────────────────
        # Bypasses Anubis PoW and Varnish cache — goes directly
        # to the gateway's Swoole WebSocket server.
        # @see docs/LIVEPOSTING.md §11.1
        location /api/socket {
            proxy_pass http://gateway_direct;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header CF-Connecting-IP  $http_cf_connecting_ip;
            proxy_set_header CF-IPCountry      $http_cf_ipcountry;

            proxy_http_version 1.1;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            # Long timeouts for persistent WebSocket connections
            proxy_read_timeout  3600s;
            proxy_send_timeout  3600s;

            # Disable proxy buffering for real-time streaming
            proxy_buffering off;
        }

        # ── Everything else → Anubis ─────────────────────────
        location / {
            limit_req zone=general burst=20 nodelay;

            proxy_pass http://anubis;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header CF-Connecting-IP  $http_cf_connecting_ip;
            proxy_set_header CF-IPCountry      $http_cf_ipcountry;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_buffering    on;
            proxy_buffer_size  4k;
            proxy_buffers      8 16k;

            # Timeouts for upstream
            proxy_connect_timeout 5s;
            proxy_read_timeout    30s;
            proxy_send_timeout    30s;
        }

        # ── Block dotfiles ───────────────────────────────────
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        # ── Favicon ──────────────────────────────────────────
        location = /favicon.ico {
            access_log off;
            log_not_found off;
        }

        # ── robots.txt (Anubis serves its own, but fallback) ─
        location = /robots.txt {
            access_log off;
            log_not_found off;
        }
    }
}
