#!/usr/bin/env bash

# Copyright 2026 txrx-byte
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

###############################################################################
# ashchan – All-in-one CLI for the Ashchan imageboard platform
#
# Usage:  ./ashchan <command> [options]
#
# Commands:
#   install          Full first-time setup (deps, certs, env, db, services)
#   start            Start all services (or a specific one)
#   stop             Stop all services (or a specific one)
#   restart          Restart all services (or a specific one)
#   status           Show service status and health
#   logs             Tail combined service logs
#   db:install       Run the database schema installer
#   db:seed          Seed the database with initial data
#   db:reset         Drop and recreate the database
#   certs:init       Generate the root CA
#   certs:generate   Generate all service certificates
#   certs:rotate     Rotate service certificates
#   certs:status     Show certificate expiry info
#   certs:verify     Verify mTLS chain
#   anubis:start     Start the Anubis AI firewall
#   anubis:stop      Stop the Anubis AI firewall
#   anubis:restart   Restart the Anubis AI firewall
#   anubis:status    Show Anubis status
#   compile          Install composer dependencies for all services
#   build            Build all static binaries (static-php-cli)
#   build:php        Build only the static PHP runtime
#   build:clean      Remove static build artifacts
#   build:<service>  Build static binary for one service
#   lint             Lint all PHP source files
#   test             Run test suites
#   clean            Remove runtime artifacts and logs
#   help             Show this help
###############################################################################

set -euo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Globals
# ─────────────────────────────────────────────────────────────────────────────

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PID_DIR="/tmp/ashchan-pids"
LOG_DIR="/tmp"

# Service definitions: name:directory:port
declare -a SVC_NAMES=(gateway auth boards media search moderation)
declare -A SVC_DIRS=(
    [gateway]=api-gateway
    [auth]=auth-accounts
    [boards]=boards-threads-posts
    [media]=media-uploads
    [search]=search-indexing
    [moderation]=moderation-anti-spam
)
declare -A SVC_PORTS=(
    [gateway]=9501  [auth]=9502  [boards]=9503
    [media]=9504    [search]=9505 [moderation]=9506
)
declare -A SVC_MTLS_PORTS=(
    [gateway]=8443  [auth]=8444  [boards]=8445
    [media]=8446    [search]=8447 [moderation]=8448
)
declare -A SVC_LABELS=(
    [gateway]="API Gateway"     [auth]="Auth / Accounts"
    [boards]="Boards / Threads" [media]="Media / Uploads"
    [search]="Search / Index"   [moderation]="Moderation"
)

# Paths
CERTS_DIR="${SCRIPT_DIR}/certs"
CA_DIR="${CERTS_DIR}/ca"
SERVICES_DIR="${CERTS_DIR}/services"
DB_DIR="${SCRIPT_DIR}/db"
ANUBIS_DIR="${SCRIPT_DIR}/config/anubis"
BUILD_SCRIPT="${SCRIPT_DIR}/build/static-php/build.sh"
STATIC_DIST="${SCRIPT_DIR}/build/static-php/dist"
ANUBIS_BIN="$(command -v anubis 2>/dev/null || echo '/usr/local/bin/anubis')"
ANUBIS_PORT=8080
ANUBIS_METRICS_PORT=9091

# Database defaults (override via env)
DB_HOST="${DB_HOST:-localhost}"
DB_PORT="${DB_PORT:-5432}"
DB_USER="${DB_USER:-ashchan}"
DB_NAME="${DB_NAME:-ashchan}"
DB_PASS="${DB_PASS:-ashchan}"
REDIS_HOST="${REDIS_HOST:-localhost}"
REDIS_PASSWORD="${REDIS_PASSWORD:-}"

# ─────────────────────────────────────────────────────────────────────────────
# Colours & formatting
# ─────────────────────────────────────────────────────────────────────────────

if [[ -t 1 ]]; then
    R='\033[0;31m'  G='\033[0;32m'  Y='\033[1;33m'
    B='\033[0;34m'  C='\033[0;36m'  M='\033[0;35m'
    BOLD='\033[1m'  DIM='\033[2m'   NC='\033[0m'
else
    R='' G='' Y='' B='' C='' M='' BOLD='' DIM='' NC=''
fi

# ─────────────────────────────────────────────────────────────────────────────
# Output helpers
# ─────────────────────────────────────────────────────────────────────────────

banner() {
    echo
    echo -e "${M}══════════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${M} ▄▀█ █▀ █░█ █▀▀ █░█ █▀█ █▄░█${NC}"
    echo -e "${BOLD}${M} █▀█ ▄█ █▀█ █▄▄ █▀█ █▀█ █░▀█${NC}"
    echo -e "${M}══════════════════════════════════════════════════${NC}"
    if [[ -n "${1:-}" ]]; then
        echo -e "${DIM}  $1${NC}"
    fi
    echo
}

info()    { echo -e "  ${B}●${NC} $1"; }
success() { echo -e "  ${G}✓${NC} $1"; }
warn()    { echo -e "  ${Y}⚠${NC} $1"; }
fail()    { echo -e "  ${R}✗${NC} $1"; }
step()    { echo -e "\n${C}━━━ $1 ━━━${NC}"; }
die()     { fail "$1"; exit 1; }

spin() {
    local pid=$1 msg=$2
    local frames=('⠋' '⠙' '⠹' '⠸' '⠼' '⠴' '⠦' '⠧' '⠇' '⠏')
    local i=0
    while kill -0 "$pid" 2>/dev/null; do
        printf "\r  ${C}%s${NC} %s" "${frames[i]}" "$msg"
        i=$(( (i + 1) % ${#frames[@]} ))
        sleep 0.08
    done
    printf "\r"
}

confirm() {
    local msg="${1:-Continue?}"
    echo -en "  ${Y}?${NC} ${msg} ${DIM}[y/N]${NC} "
    read -r -n 1 reply
    echo
    [[ "$reply" =~ ^[Yy]$ ]]
}

separator() {
    echo -e "${DIM}  ──────────────────────────────────────────────${NC}"
}

# ─────────────────────────────────────────────────────────────────────────────
# Prerequisite checks
# ─────────────────────────────────────────────────────────────────────────────

check_php() {
    command -v php &>/dev/null || die "PHP not found. Install PHP 8.2+ with Swoole."
    local ver
    ver=$(php -r "echo PHP_MAJOR_VERSION.'.'.PHP_MINOR_VERSION;")
    success "PHP ${ver}"
}

check_php_extensions() {
    local required=(swoole openssl pdo pdo_pgsql redis mbstring json curl pcntl gd fileinfo)
    local missing=()
    for ext in "${required[@]}"; do
        if ! php -m 2>/dev/null | grep -qiE "^${ext}\$"; then
            missing+=("$ext")
        fi
    done
    if [[ ${#missing[@]} -gt 0 ]]; then
        fail "Missing PHP extensions: ${missing[*]}"
        info "Install them:  sudo apk add php-swoole php-pgsql php-redis php-gd php-fileinfo"
        return 1
    fi
    success "All required PHP extensions present"
}

check_composer() {
    command -v composer &>/dev/null || die "Composer not found. Install composer globally."
    success "Composer $(composer --version 2>/dev/null | head -1 | grep -oP '[\d.]+')"
}

check_openssl() {
    command -v openssl &>/dev/null || die "OpenSSL not found."
    success "OpenSSL available"
}

check_psql() {
    if command -v psql &>/dev/null; then
        success "psql client available"
        return 0
    else
        warn "psql not found — database operations will be skipped"
        return 1
    fi
}

check_redis() {
    if redis-cli -h "$REDIS_HOST" ping &>/dev/null; then
        success "Redis responding on ${REDIS_HOST}"
        return 0
    else
        warn "Redis not responding on ${REDIS_HOST}"
        return 1
    fi
}

check_db() {
    if ! command -v psql &>/dev/null; then return 1; fi
    if PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1" &>/dev/null; then
        success "PostgreSQL connection OK (${DB_USER}@${DB_HOST}:${DB_PORT}/${DB_NAME})"
        return 0
    else
        warn "Cannot connect to PostgreSQL (${DB_USER}@${DB_HOST}:${DB_PORT}/${DB_NAME})"
        return 1
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Anubis (Web AI Firewall)
# ─────────────────────────────────────────────────────────────────────────────

check_anubis() {
    if [[ -x "$ANUBIS_BIN" ]]; then
        local ver
        ver=$("$ANUBIS_BIN" 2>&1 | head -1 || echo "unknown")
        success "Anubis available at ${ANUBIS_BIN}"
        return 0
    else
        warn "Anubis not found at ${ANUBIS_BIN}"
        info "Install: download from https://github.com/TecharoHQ/anubis/releases"
        return 1
    fi
}

anubis_is_running() {
    local pidfile="${PID_DIR}/anubis.pid"
    if [[ -f "$pidfile" ]]; then
        local pid
        pid=$(cat "$pidfile")
        if kill -0 "$pid" 2>/dev/null; then
            return 0
        fi
        rm -f "$pidfile"
    fi
    return 1
}

anubis_pid() {
    local pidfile="${PID_DIR}/anubis.pid"
    if [[ -f "$pidfile" ]]; then
        cat "$pidfile"
    fi
}

anubis_start() {
    ensure_pid_dir
    if anubis_is_running; then
        info "Anubis already running (PID $(anubis_pid))"
        return 0
    fi
    if [[ ! -x "$ANUBIS_BIN" ]]; then
        warn "Anubis binary not found — skipping"
        return 1
    fi
    if [[ ! -f "${ANUBIS_DIR}/env" ]]; then
        warn "Anubis env file not found at ${ANUBIS_DIR}/env — skipping"
        return 1
    fi

    # Source env file and export variables
    set -a
    # shellcheck source=/dev/null
    source "${ANUBIS_DIR}/env"
    set +a

    nohup "$ANUBIS_BIN" > "${LOG_DIR}/ashchan-anubis.log" 2>&1 &
    local pid=$!
    echo "$pid" > "${PID_DIR}/anubis.pid"
    sleep 0.5
    if kill -0 "$pid" 2>/dev/null; then
        success "Anubis started (PID ${pid}, port ${ANUBIS_PORT} → gateway:${SVC_PORTS[gateway]})"
    else
        fail "Anubis failed to start — check ${LOG_DIR}/ashchan-anubis.log"
        rm -f "${PID_DIR}/anubis.pid"
        return 1
    fi
}

anubis_stop() {
    if anubis_is_running; then
        local pid
        pid=$(anubis_pid)
        kill "$pid" 2>/dev/null || true
        sleep 0.5
        if kill -0 "$pid" 2>/dev/null; then
            kill -9 "$pid" 2>/dev/null || true
        fi
        rm -f "${PID_DIR}/anubis.pid"
        success "Anubis stopped (was PID ${pid})"
    else
        info "Anubis not running"
    fi
}

anubis_health() {
    if curl -s --max-time 2 "http://localhost:${ANUBIS_PORT}/health" &>/dev/null; then
        return 0
    fi
    return 1
}

# ─────────────────────────────────────────────────────────────────────────────
# Service control
# ─────────────────────────────────────────────────────────────────────────────

ensure_pid_dir() { mkdir -p "$PID_DIR"; }

svc_pid() {
    local name=$1
    local pidfile="${PID_DIR}/${name}.pid"
    if [[ -f "$pidfile" ]]; then
        local pid
        pid=$(cat "$pidfile")
        if kill -0 "$pid" 2>/dev/null; then
            echo "$pid"
            return 0
        fi
        rm -f "$pidfile"
    fi
    return 1
}

svc_is_running() { svc_pid "$1" &>/dev/null; }

svc_start() {
    local name=$1
    ensure_pid_dir
    if svc_is_running "$name"; then
        info "${SVC_LABELS[$name]} already running (PID $(svc_pid "$name"))"
        return 0
    fi
    local dir="${SCRIPT_DIR}/services/${SVC_DIRS[$name]}"
    if [[ ! -d "$dir" ]]; then
        fail "Service directory not found: $dir"
        return 1
    fi
    cd "$dir"
    nohup php bin/hyperf.php start > "${LOG_DIR}/ashchan-${name}.log" 2>&1 &
    local pid=$!
    echo "$pid" > "${PID_DIR}/${name}.pid"
    # Brief check that process didn't die immediately
    sleep 0.3
    if kill -0 "$pid" 2>/dev/null; then
        success "${SVC_LABELS[$name]} started (PID ${pid}, port ${SVC_PORTS[$name]})"
    else
        fail "${SVC_LABELS[$name]} failed to start — check ${LOG_DIR}/ashchan-${name}.log"
        rm -f "${PID_DIR}/${name}.pid"
        return 1
    fi
    cd "$SCRIPT_DIR"
}

svc_stop() {
    local name=$1
    local pid
    if pid=$(svc_pid "$name"); then
        # Kill the master and all workers
        kill "$pid" 2>/dev/null || true
        # Also kill any child workers with the same group ID
        pkill -P "$pid" 2>/dev/null || true
        sleep 0.5
        # Force kill if still alive
        if kill -0 "$pid" 2>/dev/null; then
            kill -9 "$pid" 2>/dev/null || true
            pkill -9 -P "$pid" 2>/dev/null || true
        fi
        rm -f "${PID_DIR}/${name}.pid"
        success "${SVC_LABELS[$name]} stopped (was PID ${pid})"
    else
        info "${SVC_LABELS[$name]} not running"
    fi
}

svc_health() {
    local name=$1
    local port=${SVC_PORTS[$name]}
    if curl -s --max-time 2 "http://localhost:${port}/health" &>/dev/null; then
        return 0
    fi
    return 1
}

# ─────────────────────────────────────────────────────────────────────────────
# mTLS certificates
# ─────────────────────────────────────────────────────────────────────────────

certs_init_ca() {
    step "Generating Root CA (ECDSA P-256, 10 year)"
    mkdir -p "$CA_DIR" "$SERVICES_DIR"

    if [[ -f "${CA_DIR}/ca.crt" ]] && [[ -f "${CA_DIR}/ca.key" ]]; then
        if [[ "${FORCE:-}" != "1" ]]; then
            info "CA already exists (use --force to regenerate)"
            return 0
        fi
    fi

    openssl ecparam -genkey -name prime256v1 -noout -out "${CA_DIR}/ca.key" 2>/dev/null
    chmod 644 "${CA_DIR}/ca.key"

    openssl req -new -x509 -sha256 -days 3650 \
        -key "${CA_DIR}/ca.key" \
        -out "${CA_DIR}/ca.crt" \
        -subj "/C=US/ST=California/L=San Francisco/O=Ashchan/OU=ServiceMesh/CN=ashchan-ca" \
        -addext "basicConstraints=critical,CA:TRUE" \
        -addext "keyUsage=critical,keyCertSign,cRLSign" \
        -addext "subjectKeyIdentifier=hash" 2>/dev/null

    touch "${CA_DIR}/index.txt"
    echo "1000" > "${CA_DIR}/serial"
    echo "1000" > "${CA_DIR}/crlnumber"
    cp "${CA_DIR}/ca.crt" "${SERVICES_DIR}/ca.crt"

    success "Root CA generated"
}

cert_generate_one() {
    local name=$1 dns="${2:-localhost}"
    local svc_cert_dir="${SERVICES_DIR}/${name}"
    mkdir -p "$svc_cert_dir"

    if [[ -f "${svc_cert_dir}/${name}.crt" ]] && [[ "${FORCE:-}" != "1" ]]; then
        info "${name} certificate already exists"
        return 0
    fi

    # Remove old
    rm -f "${svc_cert_dir}/${name}.crt" "${svc_cert_dir}/${name}.key" \
          "${svc_cert_dir}/${name}.csr" "${svc_cert_dir}/${name}.ext" \
          "${SERVICES_DIR}/${name}.crt" "${SERVICES_DIR}/${name}.key"

    openssl ecparam -genkey -name prime256v1 -noout -out "${svc_cert_dir}/${name}.key" 2>/dev/null
    chmod 600 "${svc_cert_dir}/${name}.key"

    openssl req -new \
        -key "${svc_cert_dir}/${name}.key" \
        -out "${svc_cert_dir}/${name}.csr" \
        -subj "/C=US/ST=California/L=San Francisco/O=Ashchan/OU=ServiceMesh/CN=${dns}" 2>/dev/null

    cat > "${svc_cert_dir}/${name}.ext" <<EOF
basicConstraints = CA:FALSE
nsCertType = server, client
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = ${dns}
DNS.2 = ${name}.ashchan.local
DNS.3 = ${name}
DNS.4 = ashchan-${name}-1
DNS.5 = localhost
EOF

    openssl x509 -req \
        -in "${svc_cert_dir}/${name}.csr" \
        -CA "${CA_DIR}/ca.crt" -CAkey "${CA_DIR}/ca.key" -CAcreateserial \
        -out "${svc_cert_dir}/${name}.crt" \
        -days 365 -sha256 \
        -extfile "${svc_cert_dir}/${name}.ext" 2>/dev/null

    cp "${svc_cert_dir}/${name}.crt" "${SERVICES_DIR}/${name}.crt"
    cp "${svc_cert_dir}/${name}.key" "${SERVICES_DIR}/${name}.key"
    rm -f "${svc_cert_dir}/${name}.csr" "${svc_cert_dir}/${name}.ext"

    success "${name} certificate issued (365 days)"
}

certs_generate_all() {
    step "Generating service certificates"
    if [[ ! -f "${CA_DIR}/ca.crt" ]]; then
        certs_init_ca
    fi
    for svc in "${SVC_NAMES[@]}"; do
        cert_generate_one "$svc" "localhost"
    done
}

certs_verify() {
    step "Verifying mTLS certificate chain"
    if [[ ! -f "${CA_DIR}/ca.crt" ]]; then
        fail "Root CA not found – run: ./ashchan certs:init"
        return 1
    fi
    local ok=0 total=0
    for svc in "${SVC_NAMES[@]}"; do
        total=$((total + 1))
        local cert="${SERVICES_DIR}/${svc}/${svc}.crt"
        if [[ ! -f "$cert" ]]; then
            fail "${svc} — certificate missing"
            continue
        fi
        if openssl verify -CAfile "${CA_DIR}/ca.crt" "$cert" &>/dev/null; then
            success "${svc} — valid"
            ok=$((ok + 1))
        else
            fail "${svc} — verification failed"
        fi
    done
    echo
    if [[ $ok -eq $total ]]; then
        success "All ${total} certificates valid"
    else
        warn "${ok}/${total} certificates valid"
    fi
}

certs_status() {
    step "Certificate expiry status"
    if [[ ! -f "${CA_DIR}/ca.crt" ]]; then
        fail "No CA found"
        return 1
    fi
    for svc in "${SVC_NAMES[@]}"; do
        local cert="${SERVICES_DIR}/${svc}/${svc}.crt"
        if [[ ! -f "$cert" ]]; then
            info "${svc}: ${R}not generated${NC}"
            continue
        fi
        local expiry days_left
        expiry=$(openssl x509 -in "$cert" -noout -enddate 2>/dev/null | cut -d= -f2)
        if date --version &>/dev/null 2>&1; then
            days_left=$(( ( $(date -d "$expiry" +%s) - $(date +%s) ) / 86400 ))
        else
            days_left=$(( ( $(date -j -f "%b %d %H:%M:%S %Y %Z" "$expiry" +%s 2>/dev/null || echo 0) - $(date +%s) ) / 86400 ))
        fi
        if [[ $days_left -lt 30 ]]; then
            warn "${svc}: expires in ${days_left} days  ⟵ renew soon"
        else
            success "${svc}: expires in ${days_left} days"
        fi
    done
}

certs_rotate() {
    step "Rotating service certificates"
    if [[ ! -f "${CA_DIR}/ca.crt" ]]; then
        die "No CA found — run ./ashchan certs:init first"
    fi

    if ! confirm "This will regenerate all service certs and restart running services."; then
        info "Aborted"
        return 0
    fi

    # Backup
    local backup="${CERTS_DIR}/backup/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$backup"
    for svc in "${SVC_NAMES[@]}"; do
        [[ -d "${SERVICES_DIR}/${svc}" ]] && cp -r "${SERVICES_DIR}/${svc}" "$backup/"
    done
    success "Backup → ${backup}"

    # Regenerate
    FORCE=1
    for svc in "${SVC_NAMES[@]}"; do
        cert_generate_one "$svc" "localhost"
    done
    unset FORCE

    # Rolling restart of running services
    local restarted=0
    for svc in "${SVC_NAMES[@]}"; do
        if svc_is_running "$svc"; then
            svc_stop "$svc"
            sleep 1
            svc_start "$svc"
            sleep 2
            restarted=$((restarted + 1))
        fi
    done
    [[ $restarted -gt 0 ]] && success "Restarted ${restarted} running service(s)"
    success "Certificate rotation complete"
}

# ─────────────────────────────────────────────────────────────────────────────
# Environment files
# ─────────────────────────────────────────────────────────────────────────────

setup_env_files() {
    step "Configuring service .env files"
    for svc in "${SVC_NAMES[@]}"; do
        local dir="${SCRIPT_DIR}/services/${SVC_DIRS[$svc]}"
        local envfile="${dir}/.env"
        local example="${dir}/.env.example"
        if [[ -f "$envfile" ]] && [[ "${FORCE:-}" != "1" ]]; then
            info "${SVC_DIRS[$svc]}/.env already exists"
            continue
        fi
        if [[ ! -f "$example" ]]; then
            warn "No .env.example for ${SVC_DIRS[$svc]}"
            continue
        fi
        sed -e "s|__PROJECT_ROOT__|${SCRIPT_DIR}|g" \
            -e "s|__DB_HOST__|${DB_HOST}|g" \
            -e "s|__REDIS_HOST__|${REDIS_HOST}|g" \
            -e "s|__REDIS_PASSWORD__|${REDIS_PASSWORD}|g" \
            -e "s|__REDIS_AUTH__|${REDIS_PASSWORD}|g" \
            "$example" > "$envfile"
        success "${SVC_DIRS[$svc]}/.env created"
    done
}

# ─────────────────────────────────────────────────────────────────────────────
# Composer / compile
# ─────────────────────────────────────────────────────────────────────────────

compile_services() {
    step "Installing composer dependencies"
    local ok=0 total=0
    for svc in "${SVC_NAMES[@]}"; do
        total=$((total + 1))
        local dir="${SCRIPT_DIR}/services/${SVC_DIRS[$svc]}"
        if [[ ! -f "${dir}/composer.json" ]]; then
            warn "${SVC_DIRS[$svc]}: no composer.json"
            continue
        fi
        info "Installing ${SVC_LABELS[$svc]}..."
        if (cd "$dir" && composer install --no-interaction --quiet 2>/dev/null); then
            success "${SVC_LABELS[$svc]} dependencies installed"
            ok=$((ok + 1))
        else
            fail "${SVC_LABELS[$svc]} composer install failed"
        fi
    done
    echo
    if [[ $ok -eq $total ]]; then
        success "All ${total} services compiled"
    else
        warn "${ok}/${total} services compiled"
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Database
# ─────────────────────────────────────────────────────────────────────────────

db_exec() {
    PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" "$@"
}

cmd_db_install() {
    step "Installing database schema"
    if ! check_db; then
        die "Cannot connect to PostgreSQL"
    fi
    local schema="${DB_DIR}/install.sql"
    if [[ ! -f "$schema" ]]; then
        die "Schema file not found: ${schema}"
    fi
    info "Applying ${schema}..."
    if db_exec -f "$schema" &>/dev/null; then
        success "Database schema installed"
    else
        fail "Schema install had errors — some tables may already exist (this is usually OK)"
    fi
}

cmd_db_seed() {
    step "Seeding database"
    if ! check_db; then
        die "Cannot connect to PostgreSQL"
    fi
    local seed="${DB_DIR}/seed.sql"
    if [[ ! -f "$seed" ]]; then
        die "Seed file not found: ${seed}"
    fi
    info "Applying ${seed}..."
    if db_exec -f "$seed" &>/dev/null; then
        success "Database seeded"
        echo
        echo -e "  ${Y}╔════════════════════════════════════════════════╗${NC}"
        echo -e "  ${Y}║  ${BOLD}DEFAULT ADMIN CREDENTIALS${NC}${Y}                       ║${NC}"
        echo -e "  ${Y}║                                                ║${NC}"
        echo -e "  ${Y}║  Username:  ${BOLD}admin${NC}${Y}                               ║${NC}"
        echo -e "  ${Y}║  Password:  ${BOLD}admin123${NC}${Y}                            ║${NC}"
        echo -e "  ${Y}║                                                ║${NC}"
        echo -e "  ${Y}║  ${R}⚠ CHANGE THIS IMMEDIATELY AFTER INSTALL${NC}${Y}      ║${NC}"
        echo -e "  ${Y}╚════════════════════════════════════════════════╝${NC}"
        echo
    else
        fail "Seeding had errors — some data may already exist (generally OK)"
    fi
}

cmd_db_reset() {
    step "Resetting database"
    if ! check_db; then
        die "Cannot connect to PostgreSQL"
    fi
    if ! confirm "This will DROP ALL TABLES and recreate the schema. Proceed?"; then
        info "Aborted"
        return 0
    fi
    info "Dropping all tables..."
    db_exec -c "
        DO \$\$ DECLARE r RECORD;
        BEGIN
            FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP
                EXECUTE 'DROP TABLE IF EXISTS ' || quote_ident(r.tablename) || ' CASCADE';
            END LOOP;
        END \$\$;
    " &>/dev/null && success "All tables dropped" || fail "Drop failed"

    cmd_db_install
    cmd_db_seed
}

# ─────────────────────────────────────────────────────────────────────────────
# Lint & test
# ─────────────────────────────────────────────────────────────────────────────

cmd_lint() {
    step "Linting PHP source files"
    local errors=0 files=0
    for svc in "${SVC_NAMES[@]}"; do
        local dir="${SCRIPT_DIR}/services/${SVC_DIRS[$svc]}"
        [[ -d "${dir}/app" ]] || continue
        while IFS= read -r -d '' f; do
            files=$((files + 1))
            if ! php -l "$f" &>/dev/null; then
                fail "$f"
                errors=$((errors + 1))
            fi
        done < <(find "$dir/app" -name '*.php' -print0 2>/dev/null)
    done
    echo
    if [[ $errors -eq 0 ]]; then
        success "All ${files} files pass syntax check"
    else
        fail "${errors}/${files} files have syntax errors"
    fi
}

cmd_test() {
    step "Running test suites"
    for svc in "${SVC_NAMES[@]}"; do
        local dir="${SCRIPT_DIR}/services/${SVC_DIRS[$svc]}"
        if [[ -f "${dir}/phpunit.xml" ]] || [[ -f "${dir}/phpunit.xml.dist" ]]; then
            info "Testing ${SVC_LABELS[$svc]}..."
            (cd "$dir" && php vendor/bin/phpunit 2>&1 | tail -3) || true
        fi
    done
}

# ─────────────────────────────────────────────────────────────────────────────
# Cleanup
# ─────────────────────────────────────────────────────────────────────────────

cmd_clean() {
    step "Cleaning runtime artifacts"
    rm -rf "$PID_DIR"
    rm -f /tmp/ashchan-*.log
    for svc in "${SVC_NAMES[@]}"; do
        rm -rf "${SCRIPT_DIR}/services/${SVC_DIRS[$svc]}/runtime" 2>/dev/null || true
    done
    success "Cleaned PID files, logs, and runtime caches"
}

# ─────────────────────────────────────────────────────────────────────────────
# Status display
# ─────────────────────────────────────────────────────────────────────────────

cmd_status() {
    step "Service status"
    printf "  ${BOLD}%-20s %-8s %-8s %-10s${NC}\n" "SERVICE" "PORT" "PID" "HEALTH"
    separator
    for svc in "${SVC_NAMES[@]}"; do
        local pid_str="-" health_str="-" health_color="$DIM"
        if svc_is_running "$svc"; then
            pid_str="$(svc_pid "$svc")"
            if svc_health "$svc"; then
                health_str="healthy"
                health_color="$G"
            else
                health_str="unhealthy"
                health_color="$Y"
            fi
        else
            health_str="stopped"
            health_color="$DIM"
        fi
        printf "  %-20s %-8s %-8s ${health_color}%-10s${NC}\n" \
            "${SVC_LABELS[$svc]}" "${SVC_PORTS[$svc]}" "$pid_str" "$health_str"
    done
    echo

    # Anubis
    echo
    printf "  ${BOLD}%-20s %-8s %-8s %-10s${NC}\n" "FIREWALL" "PORT" "PID" "HEALTH"
    separator
    local anubis_pid_str="-" anubis_health_str="-" anubis_color="$DIM"
    if anubis_is_running; then
        anubis_pid_str="$(anubis_pid)"
        if anubis_health; then
            anubis_health_str="healthy"
            anubis_color="$G"
        else
            anubis_health_str="unhealthy"
            anubis_color="$Y"
        fi
    else
        anubis_health_str="stopped"
        anubis_color="$DIM"
    fi
    printf "  %-20s %-8s %-8s ${anubis_color}%-10s${NC}\n" \
        "Anubis (AI Firewall)" "${ANUBIS_PORT}" "$anubis_pid_str" "$anubis_health_str"
    echo

    # Infrastructure
    printf "  ${BOLD}%-20s %-8s${NC}\n" "INFRASTRUCTURE" "STATUS"
    separator
    local pg_status="down" redis_status="down"
    if check_db &>/dev/null; then pg_status="${G}up${NC}"; else pg_status="${R}down${NC}"; fi
    if check_redis &>/dev/null; then redis_status="${G}up${NC}"; else redis_status="${R}down${NC}"; fi
    printf "  %-20s " "PostgreSQL"; echo -e "$pg_status"
    printf "  %-20s " "Redis"; echo -e "$redis_status"
    echo
}

# ─────────────────────────────────────────────────────────────────────────────
# Logs
# ─────────────────────────────────────────────────────────────────────────────

cmd_logs() {
    local target="${1:-all}"
    if [[ "$target" == "all" ]]; then
        echo -e "  ${DIM}Tailing all service logs (Ctrl+C to stop)${NC}"
        echo
        tail -f /tmp/ashchan-*.log 2>/dev/null || warn "No log files. Start services first."
    else
        local logfile="/tmp/ashchan-${target}.log"
        if [[ -f "$logfile" ]]; then
            tail -f "$logfile"
        else
            warn "No log file for '${target}'"
        fi
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Static binary builds
# ─────────────────────────────────────────────────────────────────────────────

cmd_build() {
    local target="${1:-all}"
    if [[ ! -f "$BUILD_SCRIPT" ]]; then
        die "Build script not found: ${BUILD_SCRIPT}"
    fi

    case "$target" in
        all)
            step "Building all static binaries"
            info "This downloads static-php-cli and compiles PHP + all services"
            info "First run may take 15-30 minutes depending on hardware"
            echo
            bash "$BUILD_SCRIPT"
            echo
            success "Static binaries available in build/static-php/dist/"
            echo
            echo -e "  ${BOLD}Deploy with:${NC}"
            separator
            echo "  scp build/static-php/dist/ashchan-* user@server:/opt/ashchan/"
            echo "  cp build/static-php/ashchan-static@.service /etc/systemd/system/"
            echo "  systemctl enable --now ashchan-static@gateway"
            echo
            ;;
        php)
            step "Building static PHP runtime only"
            bash "$BUILD_SCRIPT" --php-only
            ;;
        clean)
            step "Cleaning static build artifacts"
            bash "$BUILD_SCRIPT" --clean
            success "Static build artifacts removed"
            ;;
        *)
            if [[ -n "${SVC_DIRS[$target]+x}" ]]; then
                step "Building static binary: ${SVC_LABELS[$target]}"
                bash "$BUILD_SCRIPT" "$target"
                success "Built: build/static-php/dist/ashchan-${target}"
            else
                die "Unknown build target: ${target}. Available: all php clean ${SVC_NAMES[*]}"
            fi
            ;;
    esac
}

# ─────────────────────────────────────────────────────────────────────────────
# Full install
# ─────────────────────────────────────────────────────────────────────────────

cmd_install() {
    banner "Full Installation"

    # ─── 1. Prerequisites ───
    step "1/8  Checking prerequisites"
    check_php
    check_php_extensions || true
    check_composer
    check_openssl

    # ─── 2. mTLS ───
    step "2/8  Setting up mTLS certificates"
    certs_init_ca
    certs_generate_all

    # ─── 3. Environment ───
    step "3/8  Configuring environment"
    setup_env_files

    # ─── 4. Dependencies ───
    step "4/8  Compiling services"
    compile_services

    # ─── 5. Static binaries (optional) ───
    step "5/8  Static binary build (optional)"
    if [[ -f "$BUILD_SCRIPT" ]]; then
        info "Static builds produce single-file executables for deployment"
        info "This step is optional — services work fine without it"
        echo
        if confirm "Build static binaries? (takes 15-30 min on first run)"; then
            echo
            cmd_build all
        else
            info "Skipped — run later with:  ./ashchan build"
        fi
    else
        info "Build script not found — skipping static builds"
    fi

    # ─── 6. Database ───
    step "6/8  Database setup"
    if check_db 2>/dev/null; then
        cmd_db_install
        cmd_db_seed
    else
        warn "Skipping DB setup — PostgreSQL not reachable"
        info "Run later:  ./ashchan db:install && ./ashchan db:seed"
    fi

    # ─── 7. Start services ───
    step "7/8  Starting services"
    for svc in "${SVC_NAMES[@]}"; do
        svc_start "$svc"
        sleep 1
    done

    # Anubis (best-effort, not a numbered step)
    info "Starting Anubis (AI firewall)..."
    if check_anubis 2>/dev/null; then
        anubis_start || warn "Anubis not started — site runs without bot protection"
    else
        warn "Anubis not installed — skipping bot protection layer"
        info "Install from: https://github.com/TecharoHQ/anubis/releases"
        info "Then run:  ./ashchan anubis:start"
    fi

    # ─── 8. Health ───
    step "8/8  Verifying health"
    sleep 3
    local healthy=0
    for svc in "${SVC_NAMES[@]}"; do
        if svc_health "$svc"; then
            success "${SVC_LABELS[$svc]} — healthy"
            healthy=$((healthy + 1))
        else
            warn "${SVC_LABELS[$svc]} — not responding yet"
        fi
    done
    if anubis_is_running && anubis_health; then
        success "Anubis (AI Firewall) — healthy"
    elif anubis_is_running; then
        warn "Anubis — not responding yet"
    fi

    # ─── Summary ───
    echo
    echo -e "${M}══════════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${G}  Installation complete!${NC}  (${healthy}/${#SVC_NAMES[@]} services healthy)"
    echo -e "${M}══════════════════════════════════════════════════${NC}"
    echo
    echo -e "  ${BOLD}Endpoints${NC}"
    separator
    if anubis_is_running; then
        printf "  %-22s http://localhost:%s  ${DIM}(via Anubis)${NC}\n" "Public frontend" "${ANUBIS_PORT}"
    fi
    for svc in "${SVC_NAMES[@]}"; do
        printf "  %-22s http://localhost:%s\n" "${SVC_LABELS[$svc]}" "${SVC_PORTS[$svc]}"
    done
    echo
    echo -e "  ${BOLD}Infrastructure (required separately)${NC}"
    separator
    echo "  PostgreSQL             localhost:5432"
    echo "  Redis                  localhost:6379"
    echo "  MinIO                  localhost:9000"
    echo
    echo -e "  ${BOLD}Quick reference${NC}"
    separator
    echo "  ./ashchan status       Show service status"
    echo "  ./ashchan logs         Tail combined logs"
    echo "  ./ashchan restart      Restart all services"
    echo "  ./ashchan stop         Stop everything"
    echo
    echo -e "  ${Y}╔════════════════════════════════════════════════╗${NC}"
    echo -e "  ${Y}║  ${BOLD}DEFAULT ADMIN CREDENTIALS${NC}${Y}                       ║${NC}"
    echo -e "  ${Y}║  Username: admin    Password: admin123        ║${NC}"
    echo -e "  ${Y}║  ${R}⚠ CHANGE THIS IMMEDIATELY${NC}${Y}                      ║${NC}"
    echo -e "  ${Y}╚════════════════════════════════════════════════╝${NC}"
    echo
}

# ─────────────────────────────────────────────────────────────────────────────
# Help
# ─────────────────────────────────────────────────────────────────────────────

cmd_help() {
    banner "All-in-one CLI"
    echo -e "  ${BOLD}Usage:${NC}  ./ashchan ${C}<command>${NC} [options]"
    echo
    echo -e "  ${BOLD}Setup${NC}"
    echo -e "    ${C}install${NC}            Full first-time setup"
    echo -e "    ${C}compile${NC}            Install composer dependencies"
    echo
    echo -e "  ${BOLD}Services${NC}"
    echo -e "    ${C}start${NC}  [service]   Start all or one service"
    echo -e "    ${C}stop${NC}   [service]   Stop all or one service"
    echo -e "    ${C}restart${NC} [service]  Restart all or one service"
    echo -e "    ${C}status${NC}             Show status and health"
    echo -e "    ${C}logs${NC}   [service]   Tail service logs"
    echo
    echo -e "  ${BOLD}Database${NC}"
    echo -e "    ${C}db:install${NC}         Apply schema (db/install.sql)"
    echo -e "    ${C}db:seed${NC}            Seed initial data (db/seed.sql)"
    echo -e "    ${C}db:reset${NC}           Drop all tables and reinstall"
    echo
    echo -e "  ${BOLD}Certificates${NC}"
    echo -e "    ${C}certs:init${NC}         Generate root CA"
    echo -e "    ${C}certs:generate${NC}     Generate all service certs"
    echo -e "    ${C}certs:rotate${NC}       Rotate certs + rolling restart"
    echo -e "    ${C}certs:status${NC}       Show certificate expiry"
    echo -e "    ${C}certs:verify${NC}       Verify the mTLS chain"
    echo
    echo -e "  ${BOLD}Anubis (AI Firewall)${NC}"
    echo -e "    ${C}anubis:start${NC}       Start Anubis reverse proxy"
    echo -e "    ${C}anubis:stop${NC}        Stop Anubis"
    echo -e "    ${C}anubis:restart${NC}     Restart Anubis"
    echo -e "    ${C}anubis:status${NC}      Show Anubis status"
    echo
    echo -e "  ${BOLD}Build${NC}"
    echo -e "    ${C}build${NC}              Build all static binaries"
    echo -e "    ${C}build:php${NC}          Build only the static PHP runtime"
    echo -e "    ${C}build:clean${NC}        Remove static build artifacts"
    echo -e "    ${C}build:<service>${NC}    Build one service as static binary"
    echo
    echo -e "  ${BOLD}Quality${NC}"
    echo -e "    ${C}lint${NC}               Check PHP syntax"
    echo -e "    ${C}test${NC}               Run PHPUnit test suites"
    echo
    echo -e "  ${BOLD}Maintenance${NC}"
    echo -e "    ${C}clean${NC}              Remove logs, PIDs, caches"
    echo -e "    ${C}help${NC}               Show this help"
    echo
    echo -e "  ${BOLD}Services:${NC} gateway, auth, boards, media, search, moderation, anubis"
    echo
    echo -e "  ${BOLD}Options:${NC}"
    echo -e "    ${C}--force${NC}            Force regeneration of certs/env files"
    echo
    echo -e "  ${BOLD}Environment variables:${NC}"
    echo -e "    DB_HOST, DB_PORT, DB_USER, DB_NAME, DB_PASS"
    echo -e "    REDIS_HOST, REDIS_PASSWORD"
    echo
}

# ─────────────────────────────────────────────────────────────────────────────
# Main dispatcher
# ─────────────────────────────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"
    shift || true

    # Global flags
    for arg in "$@"; do
        case "$arg" in
            --force) FORCE=1 ;;
        esac
    done
    # Filter out flags from positional args
    local args=()
    for arg in "$@"; do
        [[ "$arg" == --* ]] || args+=("$arg")
    done

    case "$cmd" in
        install)
            cmd_install
            ;;
        start)
            banner "Starting services"
            local target="${args[0]:-all}"
            if [[ "$target" == "all" ]]; then
                for svc in "${SVC_NAMES[@]}"; do svc_start "$svc"; sleep 0.5; done
                anubis_start 2>/dev/null || true
            elif [[ "$target" == "anubis" ]]; then
                anubis_start
            else
                if [[ -n "${SVC_DIRS[$target]+x}" ]]; then
                    svc_start "$target"
                else
                    die "Unknown service: ${target}. Available: ${SVC_NAMES[*]} anubis"
                fi
            fi
            ;;
        stop)
            banner "Stopping services"
            local target="${args[0]:-all}"
            if [[ "$target" == "all" ]]; then
                anubis_stop 2>/dev/null || true
                for svc in "${SVC_NAMES[@]}"; do svc_stop "$svc"; done
            elif [[ "$target" == "anubis" ]]; then
                anubis_stop
            else
                if [[ -n "${SVC_DIRS[$target]+x}" ]]; then
                    svc_stop "$target"
                else
                    die "Unknown service: ${target}. Available: ${SVC_NAMES[*]} anubis"
                fi
            fi
            ;;
        restart)
            banner "Restarting services"
            local target="${args[0]:-all}"
            if [[ "$target" == "all" ]]; then
                anubis_stop 2>/dev/null || true
                for svc in "${SVC_NAMES[@]}"; do svc_stop "$svc"; done
                sleep 1
                for svc in "${SVC_NAMES[@]}"; do svc_start "$svc"; sleep 0.5; done
                anubis_start 2>/dev/null || true
            elif [[ "$target" == "anubis" ]]; then
                anubis_stop
                sleep 1
                anubis_start
            else
                if [[ -n "${SVC_DIRS[$target]+x}" ]]; then
                    svc_stop "$target"
                    sleep 1
                    svc_start "$target"
                else
                    die "Unknown service: ${target}. Available: ${SVC_NAMES[*]} anubis"
                fi
            fi
            ;;
        status)
            banner
            cmd_status
            ;;
        logs)
            cmd_logs "${args[0]:-all}"
            ;;
        db:install)
            banner "Database"
            cmd_db_install
            ;;
        db:seed)
            banner "Database"
            cmd_db_seed
            ;;
        db:reset)
            banner "Database"
            cmd_db_reset
            ;;
        certs:init)
            banner "Certificates"
            certs_init_ca
            ;;
        certs:generate)
            banner "Certificates"
            certs_generate_all
            ;;
        certs:rotate)
            banner "Certificates"
            certs_rotate
            ;;
        certs:status)
            banner "Certificates"
            certs_status
            ;;
        certs:verify)
            banner "Certificates"
            certs_verify
            ;;
        compile)
            banner "Compile"
            check_php
            check_composer
            compile_services
            ;;
        build)
            banner "Static Build"
            cmd_build "${args[0]:-all}"
            ;;
        build:php)
            banner "Static Build"
            cmd_build php
            ;;
        build:clean)
            banner "Static Build"
            cmd_build clean
            ;;
        build:*)
            banner "Static Build"
            local svc_target="${cmd#build:}"
            cmd_build "$svc_target"
            ;;
        lint)
            banner "Lint"
            cmd_lint
            ;;
        test)
            banner "Test"
            cmd_test
            ;;
        anubis:start)
            banner "Anubis"
            anubis_start
            ;;
        anubis:stop)
            banner "Anubis"
            anubis_stop
            ;;
        anubis:restart)
            banner "Anubis"
            anubis_stop
            sleep 1
            anubis_start
            ;;
        anubis:status)
            banner "Anubis"
            step "Anubis AI Firewall status"
            if anubis_is_running; then
                success "Running (PID $(anubis_pid), port ${ANUBIS_PORT})"
                if anubis_health; then
                    success "Health: OK"
                else
                    warn "Health: not responding"
                fi
                info "Policy: ${ANUBIS_DIR}/policy.yaml"
                info "Logs:   ${LOG_DIR}/ashchan-anubis.log"
                info "Target: http://localhost:${SVC_PORTS[gateway]} (API Gateway)"
            else
                info "Not running"
                info "Start with:  ./ashchan anubis:start"
            fi
            echo
            ;;
        clean)
            banner "Cleanup"
            cmd_clean
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            fail "Unknown command: ${cmd}"
            echo
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
