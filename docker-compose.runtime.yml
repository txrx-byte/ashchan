# Copyright 2026 txrx-byte
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# docker-compose.runtime.yml
#
# Ashchan single-image deployment using swoole-cli static binary.
# All 6 application services run from the same ashchan-runtime image;
# only the entrypoint argument and env_file differ.
#
# Prerequisites:
#   1. Build or download the swoole-cli binary into docker/swoole-cli/
#   2. Build the runtime image:
#        docker build -f Dockerfile.runtime -t ashchan-runtime:latest .
#   3. Generate mTLS certificates:
#        make mtls-init && make mtls-certs
#
# Usage:
#   docker-compose -f docker-compose.runtime.yml up -d

version: '2.4'

networks:
  ashchan-mesh:
    driver: bridge
  ashchan-public:
    driver: bridge

services:
  # ─────────────────────────────────────────────────────────────
  # Infrastructure Services (unchanged from docker-compose.yml)
  # ─────────────────────────────────────────────────────────────

  postgres:
    image: docker.io/postgres:16-alpine
    container_name: ashchan-postgres-1
    hostname: postgres.ashchan.local
    user: "70:70"
    environment:
      POSTGRES_USER: ashchan
      POSTGRES_PASSWORD: ashchan
      POSTGRES_DB: ashchan
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/migrations:/app/db/migrations:ro
    networks:
      - ashchan-mesh
    healthcheck:
      test: "pg_isready -U ashchan"
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: docker.io/redis:7-alpine
    container_name: ashchan-redis-1
    hostname: redis.ashchan.local
    user: "999:999"
    command: redis-server --requirepass "${REDIS_PASSWORD:-changeme}"
    volumes:
      - redis_data:/data
    networks:
      - ashchan-mesh
    healthcheck:
      test: "redis-cli -a \"${REDIS_PASSWORD:-changeme}\" ping"
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  minio:
    image: docker.io/minio/minio:latest
    container_name: ashchan-minio-1
    hostname: minio.ashchan.local
    user: "1000:1000"
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ashchan
      MINIO_ROOT_PASSWORD: ashchan123
    volumes:
      - minio_data:/data
    networks:
      - ashchan-mesh
    healthcheck:
      test: "curl -f http://localhost:9000/minio/health/live"
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────
  # Application Services - Single Runtime Image
  # ─────────────────────────────────────────────────────────────

  api-gateway:
    image: ashchan-runtime:latest
    container_name: ashchan-gateway-1
    hostname: gateway.ashchan.local
    command: ["gateway"]
    ports:
      - "9501:9501"
      - "9443:9443"
      - "8443:8443"
    env_file:
      - ./services/api-gateway/.env
    volumes:
      - ./frontend/static:/app/frontend/static:ro
      - ./certs/services/gateway:/etc/mtls/gateway:ro
      - ./certs/ca:/etc/mtls/ca:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ashchan-public
      - ashchan-mesh
    healthcheck:
      test: "curl -sf http://localhost:9501/health || exit 1"
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  auth-accounts:
    image: ashchan-runtime:latest
    container_name: ashchan-auth-1
    hostname: auth.ashchan.local
    command: ["auth"]
    ports:
      - "8502:8443"
    env_file:
      - ./services/auth-accounts/.env
    volumes:
      - ./certs/services/auth:/etc/mtls/auth:ro
      - ./certs/ca:/etc/mtls/ca:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ashchan-mesh
    healthcheck:
      test: "curl -sf http://localhost:9502/health || exit 1"
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  boards-threads-posts:
    image: ashchan-runtime:latest
    container_name: ashchan-boards-1
    hostname: boards.ashchan.local
    command: ["boards"]
    ports:
      - "8503:8443"
    env_file:
      - ./services/boards-threads-posts/.env
    volumes:
      - ./certs/services/boards:/etc/mtls/boards:ro
      - ./certs/ca:/etc/mtls/ca:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ashchan-mesh
    healthcheck:
      test: "curl -sf http://localhost:9503/health || exit 1"
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  media-uploads:
    image: ashchan-runtime:latest
    container_name: ashchan-media-1
    hostname: media.ashchan.local
    command: ["media"]
    ports:
      - "8504:8443"
    env_file:
      - ./services/media-uploads/.env
    volumes:
      - ./certs/services/media:/etc/mtls/media:ro
      - ./certs/ca:/etc/mtls/ca:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - ashchan-mesh
    healthcheck:
      test: "curl -sf http://localhost:9504/health || exit 1"
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  search-indexing:
    image: ashchan-runtime:latest
    container_name: ashchan-search-1
    hostname: search.ashchan.local
    command: ["search"]
    ports:
      - "8505:8443"
    env_file:
      - ./services/search-indexing/.env
    volumes:
      - ./certs/services/search:/etc/mtls/search:ro
      - ./certs/ca:/etc/mtls/ca:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ashchan-mesh
    healthcheck:
      test: "curl -sf http://localhost:9505/health || exit 1"
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  moderation-anti-spam:
    image: ashchan-runtime:latest
    container_name: ashchan-moderation-1
    hostname: moderation.ashchan.local
    command: ["moderation"]
    ports:
      - "8506:8443"
    env_file:
      - ./services/moderation-anti-spam/.env
    volumes:
      - ./certs/services/moderation:/etc/mtls/moderation:ro
      - ./certs/ca:/etc/mtls/ca:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ashchan-mesh
    healthcheck:
      test: "curl -sf http://localhost:9506/health || exit 1"
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  minio_data:
